<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>nRF5 SDK v17.0.2: Secure boot and firmware updates</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="extra_stylesheet_offline.css" rel="stylesheet" type="text/css"/>
<link href="nordic.css" rel="stylesheet" type="text/css" />
<link rel="Shortcut icon" href="./favicon.ico" type="image/x-icon" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0" width="100%" class="blank">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Nordic Semiconductor" src="nordic_small.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">nRF5 SDK
   &#160;<span id="projectnumber">v17.0.2</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
<table cellspacing="0" cellpadding="0" class="blank">
<tr>
<td class="doclinkintro">Choose documentation:</td>
<td class="doclinks" id="nrf5"><a href="../nrf5/index.html">nRF5 SDK</a></td>
<td class="doclinks" id="s112"><a href="../s112/index.html">S112 SoftDevice API</a></td>
<td class="doclinks" id="s113"><a href="../s113/index.html">S113 SoftDevice API</a></td>
<td class="doclinks" id="s122"><a href="../s122/index.html">S122 SoftDevice API</a></td>
<td class="doclinks" id="s132"><a href="../s132/index.html">S132 SoftDevice API</a></td>
<td class="doclinks" id="s140"><a href="../s140/index.html">S140 SoftDevice API</a></td>
<td class="doclinks" id="s212"><a href="../s212/index.html">S212 SoftDevice API</a></td>
<td class="doclinks" id="s312"><a href="../s312/index.html">S312 SoftDevice API</a></td>
<td class="doclinks" id="s332"><a href="../s332/index.html">S332 SoftDevice API</a></td>
<td class="doclinks" id="s340"><a href="../s340/index.html">S340 SoftDevice API</a></td>
</tr>
</table>
<script>
var url=window.location.href.split("/").reverse()[1];
var validLinks= ["nrf5","s112","s113","s122","s132","s140","s212","s312","s332","s340"];
var index;
for (index = 0; index < validLinks.length; ++index) {
   if ( url.indexOf(validLinks[index]) !== -1 ) {
      document.getElementById(validLinks[index]).setAttribute('class', 'doclinks docselected');
   };
};
</script>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('lib_secure_boot.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Secure boot and firmware updates </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#secure_boot_introduction">Introduction</a></li>
<li class="level1"><a href="#secure_boot_validation">Boot validation</a><ul><li class="level2"><a href="#secure_boot_crypto">Cryptography</a></li>
<li class="level2"><a href="#secure_boot_validation_modes">Boot validation modes</a></li>
<li class="level2"><a href="#secure_boot_mode_selection">Selecting the boot validation mode</a></li>
</ul>
</li>
<li class="level1"><a href="#secure_boot_rotr">Root of Trust (ROT) reset</a></li>
<li class="level1"><a href="#secure_boot_act_updates">Activation of updates</a></li>
<li class="level1"><a href="#secure_boot_settings_backup">Bootloader settings backup</a></li>
<li class="level1"><a href="#secure_boot_recoverability">Recoverability</a></li>
<li class="level1"><a href="#secure_boot_debug_prod">Security Configuration of the app and bootloader</a></li>
</ul>
</div>
<div class="textblock"><dl class="section warning"><dt>Warning</dt><dd>Before moving to production, make sure the configuration of the bootloader and application are tailored to your project. See <a class="el" href="lib_secure_boot.html#secure_boot_debug_prod">Security Configuration of the app and bootloader</a>.</dd></dl>
<p>Secure boot does a signature verification procedure on installed firmware before booting into it. This is to ensure that the firmware is authorized by the owner of the private key used to create the signature.</p>
<h1><a class="anchor" id="secure_boot_introduction"></a>
Introduction</h1>
<p>When an nRF5 SDK project uses a bootloader, the system can contain up to four separate, standalone programs or "images": Master Boot Record (MBR), the SoftDevice, the application, and the bootloader itself. When the chip comes out of reset, for example through a pin reset, a soft reset (triggered by software), or when waking up from a sleep state, it always starts executing the image located at address <code>0</code> (zero), unless debugging is enabled.</p>
<p>This first image that is booted is the MBR. It is required that the MBR is available as the first image. The MBR looks up the location of the bootloader and boots it. If it cannot find a bootloader, it boots the image that directly follows itself, at address <code>0x1000</code> (for nRF52 devices).</p>
<p>The bootloader is responsible for the secure boot functionality. It uses cryptographic signatures to ensure that firmware can be verified as signed by the private key, and that it is not corrupted. It does this by doing checks at two critical points: when booting the system, and whenever a firmware update is received:</p>
<ul>
<li>Checking at boot time ensures that nothing has changed the already present code. See <a class="el" href="lib_secure_boot.html#secure_boot_validation">Boot validation</a>.</li>
<li>Checking at update time ensures that any new code that arrives is also valid. See <a class="el" href="lib_secure_boot.html#secure_boot_act_updates">Activation of updates</a>.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>These checks can be enabled or disabled using the <code>sdk_config.h</code> file. This description of the secure boot process assumes that update-time signature checks are enabled.</dd></dl>
<p>In addition to cryptography, the bootloader uses hardware protection mechanisms to further ensure that the code on the device stays unchanged. nRF52 devices have a BPROT or ACL peripheral which can be used to disable write access to flash until next reset. Write access cannot be enabled again once disabled, except through a reset. The bootloader uses this functionality to protect itself and the MBR as soon as it boots, as well as for protecting the application and the SoftDevice before booting them.</p>
<div class="image">
<img src="bootloader_protection_details.svg" alt="bootloader_protection_details.svg"/>
<div class="caption">
Memory layout, protection details, and boot order</div></div>
<p> The MBR and bootloader together make up the Root of Trust (RoT) of the system. Because they are booted first, these images are able to protect the system from unintentional or malicious tampering by the application, and detect injected code.</p>
<h1><a class="anchor" id="secure_boot_validation"></a>
Boot validation</h1>
<p>The following sections describe various aspects of boot validation.</p>
<h2><a class="anchor" id="secure_boot_crypto"></a>
Cryptography</h2>
<p>The bootloader uses Elliptic Curve Digital Signature Algorithm (ECDSA) secp256r1 together with the SHA-256 hashing algorithm. The ECDSA public key is compiled into the bootloader in an uncompressed, raw format (little-endian X followed by little-endian Y). The signatures are stored as little-endian R followed by little-endian S.</p>
<dl class="section note"><dt>Note</dt><dd>"Signature" in this document refers to ECDSA digital signatures. "Digest" refers to SHA-256 cryptographic digests.</dd></dl>
<h2><a class="anchor" id="secure_boot_validation_modes"></a>
Boot validation modes</h2>
<p>Boot validation can run in four modes, depending on the configuration:</p>
<ul>
<li>Signature validation (ECDSA):<br/>
 Direct authentication against signature on each boot. Highest security and highest cost in power and time.<br/>
 Only this mode can be considered as secure boot.</li>
<li>Hash validation (SHA-256):<br/>
 Lower security, and slightly lower power and time cost. Hash validation can detect unintentional changes to code, but not intentional malicious changes that are advanced enough to circumvent the hash check or re-write the reference digest.</li>
<li>CRC validation (CRC32):<br/>
 Protection against chance events but, in theory, no protection against malicious attacks. Significantly lower power and time cost.</li>
<li>No validation:<br/>
 Power and time cost is limited to short housekeeping tasks in the MBR and bootloader, essentially applying write protection, checking whether a DFU operation has been requested, and booting to the next stage.</li>
</ul>
<h2><a class="anchor" id="secure_boot_mode_selection"></a>
Selecting the boot validation mode</h2>
<p>The firmware update package decides which mode is to be used for each image. Only the SoftDevice and the application can be validated because the bootloader performs the validation. Note that bootloaders are always checked when they are updated.</p>
<p>If the signature mode is specified, the signature is also part of the update package. This signature is verified using the same public key that is used to check the update package itself.</p>
<p>For hash and CRC modes, the reference digest is created on-chip and written to flash when the update is applied. Note that the bootloader can be configured to only accept update packages using the signature mode.</p>
<p>The four secure boot modes apply only to the boot validation, and are independent of the validation performed during firmware upgrade. That means that an update package is signed regardless of the secure boot mode contained in it. The update-time validation combined with the BPROT/ACL protection means that the system is protected from unauthorized firmware image installation even with no boot validation. This is relevant since boot validation spends both power and time on each boot, which restricts its usage in certain applications.</p>
<h1><a class="anchor" id="secure_boot_rotr"></a>
Root of Trust (ROT) reset</h1>
<p>Whenever the bootloader takes a sensitive action, like upgrading an image, the system must go through a Root of Trust reset to be put into a known state, as well as to release the BPROT/ACL protections.</p>
<h1><a class="anchor" id="secure_boot_act_updates"></a>
Activation of updates</h1>
<p>After an update package has been received, the bootloader requires a Root of Trust reset before it checks the update for the last time. If the check passes, the package is activated: it is copied into place and its metadata is written into the active part of its settings page.</p>
<p>When activating an update of the bootloader itself, the bootloader cannot perform the activation since its code cannot be running while it is being rewritten. Instead, the bootloader leverages the MBR, which has the ability to perform power-failure-safe copy operations. The bootloader calls into the MBR (through SVC) which stores the operation details in the MBR params page. The MBR then does its own Root of Trust reset and follows the instructions it left for itself in the MBR params page. If a reset happens at any time during the copy procedure, the MBR will continue or restart the copy operation, because its details are stored in flash. After this is done, it erases the MBR params page and boots the new bootloader.</p>
<h1><a class="anchor" id="secure_boot_settings_backup"></a>
Bootloader settings backup</h1>
<p>The bootloader settings page contains sensitive information that should be changed only as a result of authorized firmware upgrades. Because of this, it always keeps a protected backup. The original settings can be left open to allow the application to exchange data with the bootloader (for example, for background DFU). However, the sensitive parts of the settings page are always read from the backup to protect against both malicious and unintended tampering.</p>
<h1><a class="anchor" id="secure_boot_recoverability"></a>
Recoverability</h1>
<p>The bootloaders in the nRF5 SDK have standalone DFU capabilities, which means that even if the application is completely non-functional, the system can be recovered using the bootloader's DFU mechanism. Note that BLE bootloaders require the SoftDevice.</p>
<p>Depending on configurations, GPIOs can be used to force the bootloader into DFU mode instead of booting the current application.</p>
<h1><a class="anchor" id="secure_boot_debug_prod"></a>
Security Configuration of the app and bootloader</h1>
<p>The following configuration options are related to security. See the <code>sdk_config.h</code> file for detailed descriptions, as well as a complete list of available configuration options. See also some notes on configuration below.</p>
<ul>
<li><a class="el" href="group__nrf__bootloader__config.html#gaba572f7979df6ce7c1ed316bfab3f748">NRF_BL_APP_SIGNATURE_CHECK_REQUIRED</a></li>
<li><a class="el" href="group__nrf__bootloader__config.html#ga64c26a6c713df4e99261e8cd7f6c4fc3">NRF_BL_DEBUG_PORT_DISABLE</a></li>
<li><a class="el" href="group__nrf__dfu__validation__config.html#ga140c3ba308be36b17c1103ec105bbb32">NRF_DFU_APP_ACCEPT_SAME_VERSION</a></li>
<li><a class="el" href="group__nrf__dfu__validation__config.html#gaf215258550046aa3679a3aa9c8ae8d81">NRF_DFU_APP_DOWNGRADE_PREVENTION</a></li>
<li><a class="el" href="group__nrf__dfu__validation__config.html#ga8c6f3f88cd8392e5b33aebc24e5ed942">NRF_DFU_HW_VERSION</a></li>
<li><a class="el" href="group__nrf__dfu__validation__config.html#gab9eb15c540219bcad7bae19be44a9cad">NRF_DFU_REQUIRE_SIGNED_APP_UPDATE</a></li>
<li><a class="el" href="group__nrf__dfu__validation__config.html#ga550793eac5d299ee051e80ae17318e16">NRF_DFU_EXTERNAL_APP_VERSIONING</a> (if external apps are enabled)</li>
<li><a class="el" href="group__nrf__dfu__validation__config.html#ga9bd60b6464d75f738bb06845ec8b86a9">NRF_DFU_FORCE_DUAL_BANK_APP_UPDATES</a> (if using background DFU)</li>
<li><a class="el" href="group__nrf__dfu__config.html#gab62192ee108867e10fe5d9476e43a2a0">NRF_DFU_BLE_REQUIRES_BONDS</a> (if using buttonless BLE DFU)</li>
</ul>
<p>The flash patch functionality in Cortex-M4 can be used by malicious code to circumvent the secure boot checks. In nRF52840 and nRF52833, flash patch can be disabled by writing 0x00 to CPUFPBEN in <a href="https://infocenter.nordicsemi.com/topic/ps_nrf52840/uicr.html#register.DEBUGCTRL">DEBUGCTRL</a>. Note that this also disables breakpoints, so it is not done by default. Enabling <a class="el" href="group__nrf__bootloader__config.html#ga64c26a6c713df4e99261e8cd7f6c4fc3">NRF_BL_DEBUG_PORT_DISABLE</a> will also write 0 to CPUFPBEN.</p>
<p>The Debug Access Port (DAP) has, by default, full memory access and register access to the CPU core and peripherals. The DAP can be disabled using <a href="https://infocenter.nordicsemi.com/topic/ps_nrf52840/uicr.html#register.APPROTECT">APPROTECT</a>. In nRF52840 and nRF52833, ITM/ETM trace can also be disabled by using <a href="https://infocenter.nordicsemi.com/topic/ps_nrf52840/uicr.html#register.DEBUGCTRL">DEBUGCTRL</a>. Enabling the <a class="el" href="group__nrf__bootloader__config.html#ga64c26a6c713df4e99261e8cd7f6c4fc3">NRF_BL_DEBUG_PORT_DISABLE</a> configuration option disables both UICR registers <a href="https://infocenter.nordicsemi.com/topic/ps_nrf52840/uicr.html#register.APPROTECT">APPROTECT</a> and <a href="https://infocenter.nordicsemi.com/topic/ps_nrf52840/uicr.html#register.DEBUGCTRL">DEBUGCTRL</a>.</p>
<p>Enforcing strictly ascending application versions prevents rollback attacks which exploit known security flaws in older versions of an image. You can do this by disabling the <a class="el" href="group__nrf__dfu__validation__config.html#ga140c3ba308be36b17c1103ec105bbb32">NRF_DFU_APP_ACCEPT_SAME_VERSION</a> config option.</p>
<p>If multiple projects share a public key, images from one project can risk being applied to a device from another, potentially bricking it. To avoid this, the projects must use different HW IDs (<a class="el" href="group__nrf__dfu__validation__config.html#ga8c6f3f88cd8392e5b33aebc24e5ed942">NRF_DFU_HW_VERSION</a>).</p>
<p>Anyone with access to the private key can put any firmware they want onto your device. Private key management is outside the scope of this documentation. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<div id="nav-path" class="topicfooter">
<a href="mailto:docfeedback@nordicsemi.no?subject=Documentation%20feedback" id="maillink">Documentation feedback</a> | <a href="https://devzone.nordicsemi.com/questions/" target="_blank">Developer Zone</a> | <a href="http://response.nordicsemi.com/subscribe-to-our-newsletters" target="_blank">Subscribe</a> | Updated <span id="date"/>
<script>
var date = new Date("Mon Sep 14 2020" + " UTC");
document.getElementById("date").innerHTML = date.toJSON().slice(0, 10);
var url=window.location.href.split("?")[0];
var filename=url.substring(url.lastIndexOf('/')+1);
document.getElementById("maillink").href = "mailto:docfeedback@nordicsemi.no?subject=Documentation%20feedback"+decodeURIComponent("%26")+"body=File%20name%3A%20"+encodeURIComponent(filename);
</script>
</div>
</body>
</html>
