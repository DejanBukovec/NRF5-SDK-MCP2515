<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>nRF5 SDK v17.0.2: Usage</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="extra_stylesheet_offline.css" rel="stylesheet" type="text/css"/>
<link href="nordic.css" rel="stylesheet" type="text/css" />
<link rel="Shortcut icon" href="./favicon.ico" type="image/x-icon" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0" width="100%" class="blank">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Nordic Semiconductor" src="nordic_small.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">nRF5 SDK
   &#160;<span id="projectnumber">v17.0.2</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
<table cellspacing="0" cellpadding="0" class="blank">
<tr>
<td class="doclinkintro">Choose documentation:</td>
<td class="doclinks" id="nrf5"><a href="../nrf5/index.html">nRF5 SDK</a></td>
<td class="doclinks" id="s112"><a href="../s112/index.html">S112 SoftDevice API</a></td>
<td class="doclinks" id="s113"><a href="../s113/index.html">S113 SoftDevice API</a></td>
<td class="doclinks" id="s122"><a href="../s122/index.html">S122 SoftDevice API</a></td>
<td class="doclinks" id="s132"><a href="../s132/index.html">S132 SoftDevice API</a></td>
<td class="doclinks" id="s140"><a href="../s140/index.html">S140 SoftDevice API</a></td>
<td class="doclinks" id="s212"><a href="../s212/index.html">S212 SoftDevice API</a></td>
<td class="doclinks" id="s312"><a href="../s312/index.html">S312 SoftDevice API</a></td>
<td class="doclinks" id="s332"><a href="../s332/index.html">S332 SoftDevice API</a></td>
<td class="doclinks" id="s340"><a href="../s340/index.html">S340 SoftDevice API</a></td>
</tr>
</table>
<script>
var url=window.location.href.split("/").reverse()[1];
var validLinks= ["nrf5","s112","s113","s122","s132","s140","s212","s312","s332","s340"];
var index;
for (index = 0; index < validLinks.length; ++index) {
   if ( url.indexOf(validLinks[index]) !== -1 ) {
      document.getElementById(validLinks[index]).setAttribute('class', 'doclinks docselected');
   };
};
</script>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('lib_fds_usage.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Usage </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The following code examples show the typical usage of Flash Data Storage in an application.</p>
<h1><a class="anchor" id="lib_fds_usage_init"></a>
Initializing the module</h1>
<p>Initialization, like all other operations in FDS that involve writing or erasing flash memory, is an asynchronous operation. Completion of the operation is reported to the application through a callback.</p>
<dl class="section note"><dt>Note</dt><dd>Before initializing FDS, you must initialize the SoftDevice and register a callback handler to handle FDS events.</dd></dl>
<p>The following example code shows how to register a simple event handler with FDS and initialize the module:</p>
<div class="fragment"><div class="line"><span class="comment">// Simple event handler to handle errors during initialization.</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> fds_evt_handler(<a class="code" href="structfds__evt__t.html" title="An FDS event.">fds_evt_t</a> <span class="keyword">const</span> * p_fds_evt)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">switch</span> (p_fds_evt-&gt;<a class="code" href="structfds__evt__t.html#ac9813e4ebefeda835cf86da447c76708" title="The event ID. See fds_evt_id_t.">id</a>)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__fds.html#gga9374d0e6608b9b07940401b407617f8da4147e2842827ca524ed04dc066ccb25d" title="Event for fds_init.">FDS_EVT_INIT</a>:</div>
<div class="line">            <span class="keywordflow">if</span> (p_fds_evt-&gt;<a class="code" href="structfds__evt__t.html#a6cf66fb7c7e81a53924ba394e7a8b8af" title="The result of the operation related to this event.">result</a> != <a class="codeRef" doxygen="tag_s140_offline.tag:../s140/" href="../s140/group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123">NRF_SUCCESS</a>)</div>
<div class="line">            {</div>
<div class="line">                <span class="comment">// Initialization failed.</span></div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><a class="code" href="group__sdk__error.html#gaf6c20fb483036617204f12e99e0b997b" title="API Result.">ret_code_t</a> ret = <a class="code" href="group__fds.html#gadc98fdddd6201988f408116ee0dc4fe5" title="Function for registering an FDS event handler.">fds_register</a>(fds_evt_handler);</div>
<div class="line"><span class="keywordflow">if</span> (ret != <a class="codeRef" doxygen="tag_s140_offline.tag:../s140/" href="../s140/group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123">NRF_SUCCESS</a>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Registering of the FDS event handler has failed.</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><a class="code" href="group__sdk__error.html#gaf6c20fb483036617204f12e99e0b997b" title="API Result.">ret_code_t</a> ret = <a class="code" href="group__fds.html#ga2382947318f107a9c8d08a9a5916ccf4" title="Function for initializing the module.">fds_init</a>();</div>
<div class="line"><span class="keywordflow">if</span> (ret != <a class="codeRef" doxygen="tag_s140_offline.tag:../s140/" href="../s140/group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123">NRF_SUCCESS</a>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Handle error.</span></div>
<div class="line">}</div>
</div><!-- fragment --><p>The init operation will return an event notification upon success.</p>
<p>In the Peer Manager, <a class="el" href="group__fds.html#ga2382947318f107a9c8d08a9a5916ccf4">fds_init</a> is part of the initialization function <a class="el" href="group__peer__manager.html#ga8380e1f31d34cdacd511734cae8b6dde">pm_init</a>. The module can be initialized multiple times, with no side effects.</p>
<h1><a class="anchor" id="lib_fds_usage_store"></a>
Writing a record</h1>
<p>The following example code shows how to write a record: </p>
<div class="fragment"><div class="line"><span class="preprocessor">#define FILE_ID         0x0001  </span><span class="comment">/* The ID of the file to write the records into. */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define RECORD_KEY_1    0x1111  </span><span class="comment">/* A key for the first record. */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define RECORD_KEY_2    0x2222  </span><span class="comment">/* A key for the second record. */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> uint32_t   <span class="keyword">const</span> m_deadbeef = 0xDEADBEEF;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span>       <span class="keyword">const</span> m_hello[]  = <span class="stringliteral">&quot;Hello, world!&quot;</span>;</div>
<div class="line"></div>
<div class="line"><a class="code" href="structfds__record__t.html" title="A record to be written to flash.">fds_record_t</a>        record;</div>
<div class="line"><a class="code" href="structfds__record__desc__t.html" title="The record descriptor structure that is used to manipulate records.">fds_record_desc_t</a>   record_desc;</div>
<div class="line"></div>
<div class="line"><span class="comment">// Set up record.</span></div>
<div class="line">record.<a class="code" href="structfds__record__t.html#a2417128bc75dd4bc49cdfb8f768200a1" title="The ID of the file that the record belongs to.">file_id</a>           = FILE_ID;</div>
<div class="line">record.<a class="code" href="structfds__record__t.html#a162cb23b9b81fea13ef0fbec7014fc7c" title="The record key.">key</a>               = RECORD_KEY_1;</div>
<div class="line">record.data.p_data       = &amp;m_deadbeef;</div>
<div class="line">record.data.length_words = 1;   <span class="comment">/* one word is four bytes. */</span></div>
<div class="line"></div>
<div class="line"><a class="code" href="group__sdk__error.html#gaf6c20fb483036617204f12e99e0b997b" title="API Result.">ret_code_t</a> rc;</div>
<div class="line">rc = <a class="code" href="group__fds.html#ga0114083241dc287c7145fe113c9adc2c" title="Function for writing a record to flash.">fds_record_write</a>(&amp;record_desc, &amp;record);</div>
<div class="line"><span class="keywordflow">if</span> (rc != <a class="codeRef" doxygen="tag_s140_offline.tag:../s140/" href="../s140/group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123">NRF_SUCCESS</a>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* Handle error. */</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Set up record.</span></div>
<div class="line">record.<a class="code" href="structfds__record__t.html#a2417128bc75dd4bc49cdfb8f768200a1" title="The ID of the file that the record belongs to.">file_id</a>           = FILE_ID;</div>
<div class="line">record.<a class="code" href="structfds__record__t.html#a162cb23b9b81fea13ef0fbec7014fc7c" title="The record key.">key</a>               = RECORD_KEY_2;</div>
<div class="line">record.data.p_data       = &amp;m_hello;</div>
<div class="line"><span class="comment">/* The following calculation takes into account any eventual remainder of the division. */</span></div>
<div class="line">record.data.length_words = (<span class="keyword">sizeof</span>(m_hello) + 3) / 4;</div>
<div class="line"></div>
<div class="line">rc = <a class="code" href="group__fds.html#ga0114083241dc287c7145fe113c9adc2c" title="Function for writing a record to flash.">fds_record_write</a>(&amp;record_desc, &amp;record);</div>
<div class="line"><span class="keywordflow">if</span> (rc != <a class="codeRef" doxygen="tag_s140_offline.tag:../s140/" href="../s140/group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123">NRF_SUCCESS</a>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* Handle error. */</span></div>
<div class="line">}</div>
</div><!-- fragment --><p>The command is queued up, and the success or failure is indicated through event callbacks. Upon success, the <a class="el" href="group__fds.html#ga0114083241dc287c7145fe113c9adc2c">fds_record_write</a> function returns a descriptor for the record, which can be used to further manipulate the record.</p>
<p>See <a class="el" href="lib_fds_functionality.html#lib_fds_functionality_keys">Restrictions on keys and IDs</a> for information about valid record keys and file IDs.</p>
<h1><a class="anchor" id="lib_fds_usage_retrieve"></a>
Retrieving data</h1>
<p>The following example code shows how to use the find record functionality to retrieve record descriptors for all records that match a specific key and file ID and read their contents:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define FILE_ID     0x1111</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define RECORD_KEY  0x2222</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><a class="code" href="structfds__flash__record__t.html" title="Structure that can be used to read the contents of a record stored in flash.">fds_flash_record_t</a>  flash_record;</div>
<div class="line"><a class="code" href="structfds__record__desc__t.html" title="The record descriptor structure that is used to manipulate records.">fds_record_desc_t</a>   record_desc;</div>
<div class="line"><a class="code" href="structfds__find__token__t.html" title="A token to keep information about the progress of fds_record_find, fds_record_find_by_key, and fds_record_find_in_file.">fds_find_token_t</a>    ftok;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* It is required to zero the token before first use. */</span></div>
<div class="line">memset(&amp;ftok, 0x00, <span class="keyword">sizeof</span>(<a class="code" href="structfds__find__token__t.html" title="A token to keep information about the progress of fds_record_find, fds_record_find_by_key, and fds_record_find_in_file.">fds_find_token_t</a>));</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Loop until all records with the given key and file ID have been found. */</span></div>
<div class="line"><span class="keywordflow">while</span> (<a class="code" href="group__fds.html#ga15112e682cc2c4771945fcf5816e3b1b" title="Function for searching for records with a given record key in a file.">fds_record_find</a>(FILE_ID, RECORD_KEY, &amp;record_desc, &amp;ftok) == <a class="codeRef" doxygen="tag_s140_offline.tag:../s140/" href="../s140/group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123">NRF_SUCCESS</a>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group__fds.html#gab718add23b30b0e663e48a781645879f" title="Function for opening a record for reading.">fds_record_open</a>(&amp;record_desc, &amp;flash_record) != <a class="codeRef" doxygen="tag_s140_offline.tag:../s140/" href="../s140/group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123">NRF_SUCCESS</a>)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* Handle error. */</span></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Access the record through the flash_record structure. */</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Close the record when done. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group__fds.html#gaf8d958ecd339e9d2fc3dba40c4503eea" title="Function for closing a record.">fds_record_close</a>(&amp;record_desc) != <a class="codeRef" doxygen="tag_s140_offline.tag:../s140/" href="../s140/group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123">NRF_SUCCESS</a>)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* Handle error. */</span></div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p>Closing a record with <a class="el" href="group__fds.html#gaf8d958ecd339e9d2fc3dba40c4503eea">fds_record_close</a> will not invalidate the record descriptor or the <a class="el" href="structfds__flash__record__t.html">fds_flash_record_t</a> structure. The record descriptor can still be used to manipulate the record to, for example, open it again or delete it. However, the data pointed to by the <a class="el" href="structfds__flash__record__t.html">fds_flash_record_t</a> structure might change at any time after the record is closed. So if you need to access the data after closing the record, you must open it again.</p>
<h1><a class="anchor" id="lib_fds_usage_clear"></a>
Deleting a record</h1>
<p>The following example code shows how to delete a record:</p>
<div class="fragment"><div class="line"><span class="comment">/* Assume a descriptor returned by a call to fds_record_write() or fds_record_find(),</span></div>
<div class="line"><span class="comment">   as shown in the previous example. */</span></div>
<div class="line"><a class="code" href="structfds__record__desc__t.html" title="The record descriptor structure that is used to manipulate records.">fds_record_desc_t</a> descriptor;</div>
<div class="line"></div>
<div class="line"><a class="code" href="group__sdk__error.html#gaf6c20fb483036617204f12e99e0b997b" title="API Result.">ret_code_t</a> ret = <a class="code" href="group__fds.html#gaf97cabe15afd74024e4250e931c720cd" title="Function for deleting a record.">fds_record_delete</a>(&amp;descriptor);</div>
<div class="line"><span class="keywordflow">if</span> (ret != <a class="codeRef" doxygen="tag_s140_offline.tag:../s140/" href="../s140/group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123">NRF_SUCCESS</a>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* Error. */</span></div>
<div class="line">}</div>
</div><!-- fragment --><p>The operation is queued up, and the success or failure is indicated through event callbacks.</p>
<p>Calling <a class="el" href="group__fds.html#gaf97cabe15afd74024e4250e931c720cd">fds_record_delete</a> will not free the flash memory used by the record. To reclaim the flash space used by records that were deleted, run a garbage collection (<a class="el" href="group__fds.html#ga90285f376c435c64b352023e725b7ebb">fds_gc</a>). </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<div id="nav-path" class="topicfooter">
<a href="mailto:docfeedback@nordicsemi.no?subject=Documentation%20feedback" id="maillink">Documentation feedback</a> | <a href="https://devzone.nordicsemi.com/questions/" target="_blank">Developer Zone</a> | <a href="http://response.nordicsemi.com/subscribe-to-our-newsletters" target="_blank">Subscribe</a> | Updated <span id="date"/>
<script>
var date = new Date("Mon Sep 14 2020" + " UTC");
document.getElementById("date").innerHTML = date.toJSON().slice(0, 10);
var url=window.location.href.split("?")[0];
var filename=url.substring(url.lastIndexOf('/')+1);
document.getElementById("maillink").href = "mailto:docfeedback@nordicsemi.no?subject=Documentation%20feedback"+decodeURIComponent("%26")+"body=File%20name%3A%20"+encodeURIComponent(filename);
</script>
</div>
</body>
</html>
