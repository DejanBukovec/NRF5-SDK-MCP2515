<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>nRF5 SDK v17.0.2: Connection Parameters Negotiation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="extra_stylesheet_offline.css" rel="stylesheet" type="text/css"/>
<link href="nordic.css" rel="stylesheet" type="text/css" />
<link rel="Shortcut icon" href="./favicon.ico" type="image/x-icon" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0" width="100%" class="blank">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Nordic Semiconductor" src="nordic_small.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">nRF5 SDK
   &#160;<span id="projectnumber">v17.0.2</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
<table cellspacing="0" cellpadding="0" class="blank">
<tr>
<td class="doclinkintro">Choose documentation:</td>
<td class="doclinks" id="nrf5"><a href="../nrf5/index.html">nRF5 SDK</a></td>
<td class="doclinks" id="s112"><a href="../s112/index.html">S112 SoftDevice API</a></td>
<td class="doclinks" id="s113"><a href="../s113/index.html">S113 SoftDevice API</a></td>
<td class="doclinks" id="s122"><a href="../s122/index.html">S122 SoftDevice API</a></td>
<td class="doclinks" id="s132"><a href="../s132/index.html">S132 SoftDevice API</a></td>
<td class="doclinks" id="s140"><a href="../s140/index.html">S140 SoftDevice API</a></td>
<td class="doclinks" id="s212"><a href="../s212/index.html">S212 SoftDevice API</a></td>
<td class="doclinks" id="s312"><a href="../s312/index.html">S312 SoftDevice API</a></td>
<td class="doclinks" id="s332"><a href="../s332/index.html">S332 SoftDevice API</a></td>
<td class="doclinks" id="s340"><a href="../s340/index.html">S340 SoftDevice API</a></td>
</tr>
</table>
<script>
var url=window.location.href.split("/").reverse()[1];
var validLinks= ["nrf5","s112","s113","s122","s132","s140","s212","s312","s332","s340"];
var index;
for (index = 0; index < validLinks.length; ++index) {
   if ( url.indexOf(validLinks[index]) !== -1 ) {
      document.getElementById(validLinks[index]).setAttribute('class', 'doclinks docselected');
   };
};
</script>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('lib_ble_conn_params.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Connection Parameters Negotiation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="whichSDs"><span>This information applies to the following SoftDevices: <b>S132, S140</b></span></div><p>Module for initiating and executing a connection parameters negotiation procedure.</p>
<p>This module is only relevant for BLE peripherals. Most use cases require what is referred to as Fast Connection Parameters as soon as a connection is established in order to ensure that service discovery and connection procedures happen quickly. However, continuing with these parameters through out the connection may be unnecessary drain of battery since many applications require a less frequent data exchange. Therefore, it is recommended that the peripheral applications request the master to update connection parameters. The Connection parameters negotiation library of the SDK provides the functionality to do so.</p>
<h1><a class="anchor" id="Overview"></a>
Overview</h1>
<p>On initialization, the library can be provided with the desired connection parameters to be used for the link along with when the negotiation of connection parameters should start, how many times negotiation is to be attempted and what action to take if negotiation fails.</p>
<h1><a class="anchor" id="lib_ble_conn_params_init"></a>
Initialization and Set-up</h1>
<p>The library must be set up for negotiating the connection parameters on the link. This is done by calling the <a class="el" href="group__ble__conn__params.html#ga9eb39f84188e0fbbc81966892e8f450b">ble_conn_params_init</a> API. The application should indicate when the first connection parameter request should be sent to the peer, how many times the library should attempt negotiating the parameters and what should be the time interval between each attempt. The application can also indicate if the library should initiate disconnection in case connection parameters could not be negotiated as desired by the application. Additionally, application can register with the library to be notified of events and errors.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define FIRST_CONN_PARAMS_UPDATE_DELAY   5000            // 5 seconds delay before negotiation is initiated.</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define NEXT_CONN_PARAMS_UPDATE_DELAY    30000           // 30 seconds delay for subsequent request to be sent in case parameters are not updated as requested.</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MAX_CONN_PARAMS_UPDATE_COUNT     3               // Number of times negotiation is attempted.</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define MIN_CONN_INTERVAL                MSEC_TO_UNITS(7.5, UNIT_1_25_MS)       // Minimum connection interval (7.5 ms).</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MAX_CONN_INTERVAL                MSEC_TO_UNITS(30, UNIT_1_25_MS)        // Maximum connection interval (30 ms).</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define SLAVE_LATENCY                    6                                      // Slave latency.</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CONN_SUP_TIMEOUT                 MSEC_TO_UNITS(300, UNIT_10_MS)         // Connection supervisory timeout (300 ms).</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">.</div>
<div class="line">.</div>
<div class="line">.</div>
<div class="line"></div>
<div class="line">ble_conn_params_init_t conn_param_init;</div>
<div class="line"><a class="codeRef" doxygen="tag_s140_offline.tag:../s140/" href="../s140/structble__gap__conn__params__t.html">ble_gap_conn_params_t</a>  preferred_conn_param;</div>
<div class="line"><a class="code" href="group__sdk__error.html#gaf6c20fb483036617204f12e99e0b997b" title="API Result.">ret_code_t</a>             retval;</div>
<div class="line"></div>
<div class="line">memset(&amp;cp_init, 0, <span class="keyword">sizeof</span>(<a class="code" href="structble__conn__params__init__t.html" title="Connection Parameters Module init structure. This contains all options and data needed for initializa...">ble_conn_params_init_t</a>));</div>
<div class="line"></div>
<div class="line"><span class="comment">// Connection parameters preferred by the application.</span></div>
<div class="line">preferred_conn_param.<a class="codeRef" doxygen="tag_s140_offline.tag:../s140/" href="../s140/structble__gap__conn__params__t.html#a4d1975f7d25263004c405e0321fbae34">min_conn_interval</a> = <a class="code" href="group__eddystone__app__config.html#ga95196d5d0f40cf195a6001955d6d98cf" title="Minimum acceptable connection interval (20 ms). The connection interval uses 1.25 ms units...">MIN_CONN_INTERVAL</a>;</div>
<div class="line">preferred_conn_param.<a class="codeRef" doxygen="tag_s140_offline.tag:../s140/" href="../s140/structble__gap__conn__params__t.html#abd7a6e16a723de1d779afadae3f3113e">max_conn_interval</a> = <a class="code" href="group__eddystone__app__config.html#ga7d868ed8adb7d475b463fd8855907a18" title="Maximum acceptable connection interval (75 ms). The connection interval uses 1.25 ms units...">MAX_CONN_INTERVAL</a>;</div>
<div class="line">preferred_conn_param.<a class="codeRef" doxygen="tag_s140_offline.tag:../s140/" href="../s140/structble__gap__conn__params__t.html#aa5caf55715aaac33f56cc996f91a92cc">slave_latency</a>     = <a class="code" href="group__eddystone__app__config.html#ga0c921a874ac37870fc1516ce66cd228a" title="Slave latency.">SLAVE_LATENCY</a>;</div>
<div class="line">preferred_conn_param.<a class="codeRef" doxygen="tag_s140_offline.tag:../s140/" href="../s140/structble__gap__conn__params__t.html#ab644e629af7eb4915b0f3a93f682f7ae">conn_sup_timeout</a>  = <a class="code" href="group__eddystone__app__config.html#ga799412c2b531ca347e13611e6e7523b9" title="Connection supervision time-out (4 seconds). The supervision time-out uses 10 ms units.">CONN_SUP_TIMEOUT</a>;</div>
<div class="line"></div>
<div class="line">conn_param_init.p_conn_params                  = &amp;preferred_conn_param;</div>
<div class="line">conn_param_init.first_conn_params_update_delay = <a class="code" href="group__eddystone__app__config.html#ga7204f7a367e8f1ac53ef62c4ad220efc" title="Time from initiating an event (connection or start of notification) to the first time sd_ble_gap_conn...">FIRST_CONN_PARAMS_UPDATE_DELAY</a>;</div>
<div class="line">conn_param_init.next_conn_params_update_delay  = <a class="code" href="group__eddystone__app__config.html#gadf85796ef07632ed27e0bce9509d9245" title="Time between each call to sd_ble_gap_conn_param_update after the first call (30 seconds).">NEXT_CONN_PARAMS_UPDATE_DELAY</a>;</div>
<div class="line">conn_param_init.max_conn_params_update_count   = <a class="code" href="group__eddystone__app__config.html#ga34db81384bfbef23dedbef9bc6dfe46c" title="Number of attempts before giving up the connection parameter negotiation.">MAX_CONN_PARAMS_UPDATE_COUNT</a>;</div>
<div class="line">conn_param_init.start_on_notify_cccd_handle    = <a class="codeRef" doxygen="tag_s140_offline.tag:../s140/" href="../s140/group___b_l_e___g_a_t_t___d_e_f_i_n_e_s.html#ga755613d0f9d0979be50a3814c1436ab9">BLE_GATT_HANDLE_INVALID</a>;</div>
<div class="line">conn_param_init.disconnect_on_fail             = <span class="keyword">false</span>;</div>
<div class="line">conn_param_init.evt_handler                    = conn_params_event_handler;</div>
<div class="line">conn_param_init.error_handler                  = conn_params_error_handler;</div>
<div class="line"></div>
<div class="line"><span class="comment">// Initialize and set up connection parameter negotiation module.</span></div>
<div class="line">retval = <a class="code" href="group__ble__conn__params.html#ga9eb39f84188e0fbbc81966892e8f450b" title="Function for initializing the Connection Parameters module.">ble_conn_params_init</a>(&amp;cp_init);</div>
<div class="line"></div>
<div class="line"><span class="keywordflow">if</span>(retval == <a class="codeRef" doxygen="tag_s140_offline.tag:../s140/" href="../s140/group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123">NRF_SUCCESS</a>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Procedure request succeeded. Connection parameters will be negotiated as requested.</span></div>
<div class="line">    <span class="comment">// BLE_CONN_PARAMS_EVT_SUCCEEDED or BLE_CONN_PARAMS_EVT_FAILED</span></div>
<div class="line">    <span class="comment">// will be notified if parameter negotiation is successful or not.</span></div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">else</span></div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Procedure request failed.</span></div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="lib_ble_conn_params_stop"></a>
Shutdown</h1>
<p>This routine must be called when the application is disabling the SoftDevice or the application does not want the parameters to be negotiated any longer. This must be called to ensure the timers used by the library are not longer active.</p>
<div class="fragment"><div class="line">uint32_t retval;</div>
<div class="line"></div>
<div class="line"><span class="comment">// Stop connection parameter update negotiation.</span></div>
<div class="line">retval = <a class="code" href="group__ble__conn__params.html#ga15207947845d6cdcad5b6847d94e6d10" title="Function for stopping the Connection Parameters module.">ble_conn_params_stop</a>();</div>
<div class="line"></div>
<div class="line"><span class="keywordflow">if</span>(retval == <a class="codeRef" doxygen="tag_s140_offline.tag:../s140/" href="../s140/group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123">NRF_SUCCESS</a>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Procedure successful!</span></div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">else</span></div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Procedure failed. Take recovery action.</span></div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="lib_ble_conn_params_change_conn_params"></a>
Renegotiate Connection Parameters</h1>
<p>In case application needs to negotiate new connection parameters with a central, it can do so using the <a class="el" href="group__ble__conn__params.html#gacbff87b2c34166d2604d15c74201ea55">ble_conn_params_change_conn_params</a> API. This API can be used multiple times when in connection. This procedure should not be initiated if a negotiation is already ongoing.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define MIN_CONN_INTERVAL                MSEC_TO_UNITS(75, UNIT_1_25_MS)               // Minimum connection interval (75 ms).</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MAX_CONN_INTERVAL                MSEC_TO_UNITS(300, UNIT_1_25_MS)              // Maximum connection interval (300 ms).</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define SLAVE_LATENCY                    6                                             // Slave latency.</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CONN_SUP_TIMEOUT                 MSEC_TO_UNITS(3000, UNIT_10_MS)               // Connection supervisory time-out (3 s).</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">.</div>
<div class="line">.</div>
<div class="line">.</div>
<div class="line"></div>
<div class="line">ble_gap_conn_params_t  updated_conn_param;</div>
<div class="line">uint32_t               retval;</div>
<div class="line"></div>
<div class="line"><span class="comment">// Update in Connection parameters preferred by the application.</span></div>
<div class="line">updated_conn_param.min_conn_interval = <a class="code" href="group__eddystone__app__config.html#ga95196d5d0f40cf195a6001955d6d98cf" title="Minimum acceptable connection interval (20 ms). The connection interval uses 1.25 ms units...">MIN_CONN_INTERVAL</a>;</div>
<div class="line">updated_conn_param.max_conn_interval = <a class="code" href="group__eddystone__app__config.html#ga7d868ed8adb7d475b463fd8855907a18" title="Maximum acceptable connection interval (75 ms). The connection interval uses 1.25 ms units...">MAX_CONN_INTERVAL</a>;</div>
<div class="line">updated_conn_param.slave_latency     = <a class="code" href="group__eddystone__app__config.html#ga0c921a874ac37870fc1516ce66cd228a" title="Slave latency.">SLAVE_LATENCY</a>;</div>
<div class="line">updated_conn_param.conn_sup_timeout  = <a class="code" href="group__eddystone__app__config.html#ga799412c2b531ca347e13611e6e7523b9" title="Connection supervision time-out (4 seconds). The supervision time-out uses 10 ms units.">CONN_SUP_TIMEOUT</a>;</div>
<div class="line"></div>
<div class="line"><span class="comment">// Initialize and set-up connection parameter negotiation module.</span></div>
<div class="line">retval = <a class="code" href="group__ble__conn__params.html#gacbff87b2c34166d2604d15c74201ea55" title="Function for changing the current connection parameters to a new set.">ble_conn_params_change_conn_params</a>(conn_handle, &amp;updated_conn_param);</div>
<div class="line"></div>
<div class="line"><span class="keywordflow">if</span>(retval == <a class="codeRef" doxygen="tag_s140_offline.tag:../s140/" href="../s140/group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123">NRF_SUCCESS</a>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Procedure request succeeded. Connection parameters will be negotiated as requested.</span></div>
<div class="line">    <span class="comment">// BLE_CONN_PARAMS_EVT_SUCCEEDED will be notified if parameter negotiation is successful.</span></div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">else</span></div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Procedure request failed.</span></div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<div id="nav-path" class="topicfooter">
<a href="mailto:docfeedback@nordicsemi.no?subject=Documentation%20feedback" id="maillink">Documentation feedback</a> | <a href="https://devzone.nordicsemi.com/questions/" target="_blank">Developer Zone</a> | <a href="http://response.nordicsemi.com/subscribe-to-our-newsletters" target="_blank">Subscribe</a> | Updated <span id="date"/>
<script>
var date = new Date("Mon Sep 14 2020" + " UTC");
document.getElementById("date").innerHTML = date.toJSON().slice(0, 10);
var url=window.location.href.split("?")[0];
var filename=url.substring(url.lastIndexOf('/')+1);
document.getElementById("maillink").href = "mailto:docfeedback@nordicsemi.no?subject=Documentation%20feedback"+decodeURIComponent("%26")+"body=File%20name%3A%20"+encodeURIComponent(filename);
</script>
</div>
</body>
</html>
