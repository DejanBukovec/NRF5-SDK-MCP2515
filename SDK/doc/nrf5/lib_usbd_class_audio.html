<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>nRF5 SDK v17.0.2: USB audio class module</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="extra_stylesheet_offline.css" rel="stylesheet" type="text/css"/>
<link href="nordic.css" rel="stylesheet" type="text/css" />
<link rel="Shortcut icon" href="./favicon.ico" type="image/x-icon" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0" width="100%" class="blank">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Nordic Semiconductor" src="nordic_small.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">nRF5 SDK
   &#160;<span id="projectnumber">v17.0.2</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
<table cellspacing="0" cellpadding="0" class="blank">
<tr>
<td class="doclinkintro">Choose documentation:</td>
<td class="doclinks" id="nrf5"><a href="../nrf5/index.html">nRF5 SDK</a></td>
<td class="doclinks" id="s112"><a href="../s112/index.html">S112 SoftDevice API</a></td>
<td class="doclinks" id="s113"><a href="../s113/index.html">S113 SoftDevice API</a></td>
<td class="doclinks" id="s122"><a href="../s122/index.html">S122 SoftDevice API</a></td>
<td class="doclinks" id="s132"><a href="../s132/index.html">S132 SoftDevice API</a></td>
<td class="doclinks" id="s140"><a href="../s140/index.html">S140 SoftDevice API</a></td>
<td class="doclinks" id="s212"><a href="../s212/index.html">S212 SoftDevice API</a></td>
<td class="doclinks" id="s312"><a href="../s312/index.html">S312 SoftDevice API</a></td>
<td class="doclinks" id="s332"><a href="../s332/index.html">S332 SoftDevice API</a></td>
<td class="doclinks" id="s340"><a href="../s340/index.html">S340 SoftDevice API</a></td>
</tr>
</table>
<script>
var url=window.location.href.split("/").reverse()[1];
var validLinks= ["nrf5","s112","s113","s122","s132","s140","s212","s312","s332","s340"];
var index;
for (index = 0; index < validLinks.length; ++index) {
   if ( url.indexOf(validLinks[index]) !== -1 ) {
      document.getElementById(validLinks[index]).setAttribute('class', 'doclinks docselected');
   };
};
</script>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('lib_usbd_class_audio.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">USB audio class module </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="whichnRF nRF52840"><span>This information applies to the following SoCs: <b>nRF52820</b>, <b>nRF52833</b>, and <b>nRF52840</b>.</span></div><p>This module allows to create and handle USB audio class instances. For detailed information on the USB audio class, refer to these specification documents:</p>
<ul>
<li><a href="http://www.usb.org/developers/docs/devclass_docs/audio10.pdf" target="_blank">Universal Serial Bus Device Class Definition for Audio Devices</a></li>
</ul>
<ul>
<li><a href="http://www.usb.org/developers/docs/devclass_docs/frmts10.pdf" target="_blank">Universal Serial Bus Device Class Definition for Audio Data Formats</a></li>
</ul>
<ul>
<li><a href="http://www.usb.org/developers/docs/devclass_docs/termt10.pdf" target="_blank">Universal Serial Bus Device Class Definition for Terminal Types</a></li>
</ul>
<h1><a class="anchor" id="define_audio_descriptor"></a>
Defining audio class descriptors</h1>
<p>A typical audio class has one control interface and one streaming interface. Before you can declare a class instance, you must first properly define the audio class descriptors:</p>
<ul>
<li>Format descriptor</li>
<li>Input terminal descriptor</li>
<li>Output terminal descriptor</li>
<li>Feature unit descriptor</li>
</ul>
<p>Example 1: Layout of headphone descriptors:</p>
<div class="fragment"><div class="line"> AUDIO_CONTROL_INTERFACE</div>
<div class="line"> AUDIO_CONTROL_HEADER</div>
<div class="line">    INPUT_TERMINAL</div>
<div class="line">    FEATURE_UNIT</div>
<div class="line">    OUTPUT_TERMINAL</div>
<div class="line">AUDIO_STREAMING_INTERFACE_ALTERNATE0</div>
<div class="line">AUDIO_STREAMING_INTERFACE_ALTERNATE1</div>
<div class="line">    AS_FORMAT_III</div>
<div class="line">    EP_GENERAL</div>
<div class="line">    ISO_EP_OUT</div>
</div><!-- fragment --><p>Example 2: Layout of microphone descriptors:</p>
<div class="fragment"><div class="line">AUDIO_CONTROL_INTERFACE</div>
<div class="line">AUDIO_CONTROL_HEADER</div>
<div class="line">   INPUT_TERMINAL</div>
<div class="line">   FEATURE_UNIT</div>
<div class="line">   OUTPUT_TERMINAL</div>
<div class="line">AUDIO_STREAMING_INTERFACE_ALTERNATE0</div>
<div class="line">AUDIO_STREAMING_INTERFACE_ALTERNATE1</div>
<div class="line">   AS_FORMAT_I</div>
<div class="line">   EP_GENERAL</div>
<div class="line">   ISO_EP_IN </div>
</div><!-- fragment --><p>The difference between headphones and microphone descriptors is in the direction of the isochronous endpoint descriptor. Microphone has the IN direction defined (from the USB device to the host). For headphones, the isochronous endpoint direction is set to OUT (from the host to the USB device). Both of these classes have two audio streaming descriptors:</p>
<ul>
<li>Streaming interface, alternate setting 0, is selected by the host when no isochronous transfers are required.</li>
<li>Streaming interface, alternate setting 1, has the following three descriptors defined:<ul>
<li>Audio streaming format descriptor (I, II, or III)</li>
<li>Audio streaming endpoint descriptor</li>
<li>Standard endpoint descriptor</li>
</ul>
</li>
</ul>
<p>Example: Descriptors for an audio class (Headphones: 2 channels, Fs = 48KHz, Format 16bit PCM): </p>
<div class="fragment"><div class="line"><span class="comment">/* Headphones descriptors */</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment">   @brief   Audio class specific format III descriptor</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><a class="code" href="group__app__usbd__audio.html#ga554b293ab1325a8ba3fd02f005bb70b1" title="Initializer of Audio Format descriptor.">APP_USBD_AUDIO_FORMAT_DESCRIPTOR</a>(m_hp_form_desc, </div>
<div class="line">                                 <a class="code" href="group__app__usbd__audio__dsc.html#gad2fe58576e7688a63d28aaed9c9c1d69" title="Initializer of app_usbd_audio_as_format_type_three_desc_t.">APP_USBD_AUDIO_AS_FORMAT_III_DSC</a>(    <span class="comment">/* Format type 3 descriptor */</span></div>
<div class="line">                                    2,                                <span class="comment">/* Number of channels */</span></div>
<div class="line">                                    2,                                <span class="comment">/* Subframe size */</span></div>
<div class="line">                                    16,                               <span class="comment">/* Bit resolution */</span></div>
<div class="line">                                    1,                                <span class="comment">/* Frequency type */</span></div>
<div class="line">                                    <a class="code" href="group__app__usbd__descriptor.html#ga62bfea6b42af7802eef498fddd3f44a2" title="Helper macro for translating unsigned 24 bit value to 3 byte raw descriptor.">APP_USBD_U24_TO_RAW_DSC</a>(48000))   <span class="comment">/* Frequency */</span></div>
<div class="line">                                );</div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment">   @brief   Audio class input terminal descriptor</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><a class="code" href="group__app__usbd__audio.html#ga327da518cea06cc4c6a82b5f81d15c0b" title="Initializer of Audio Input descriptor.">APP_USBD_AUDIO_INPUT_DESCRIPTOR</a>(m_hp_inp_desc, </div>
<div class="line">                                <a class="code" href="group__app__usbd__audio__dsc.html#ga40f7b549eb2a9399a87ef464561c3885" title="Initializer of app_usbd_audio_input_terminal_desc_t.">APP_USBD_AUDIO_INPUT_TERMINAL_DSC</a>(</div>
<div class="line">                                    1,                                     <span class="comment">/* Terminal ID */</span></div>
<div class="line">                                    <a class="code" href="group__app__usbd__audio__types.html#ggae0b8009c9bf0ca55d9e7588fdbcef2a2a977b23e6501180443955bdd4fa578e27">APP_USBD_AUDIO_TERMINAL_USB_STREAMING</a>, <span class="comment">/* Terminal type */</span></div>
<div class="line">                                    2,                                     <span class="comment">/* Number of channels */</span></div>
<div class="line">                                    HP_TERMINAL_CH_CONFIG())               <span class="comment">/* Channels config */</span></div>
<div class="line">                               );</div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment">   @brief   Audio class output terminal descriptor</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><a class="code" href="group__app__usbd__audio.html#gae789a820b43c42433b1b479178d8b791" title="Initializer of Audio Output descriptor.">APP_USBD_AUDIO_OUTPUT_DESCRIPTOR</a>(m_hp_out_desc, </div>
<div class="line">                                 <a class="code" href="group__app__usbd__audio__dsc.html#gadef33b05f8d70091b084b7609f1da6b5" title="Initializer of app_usbd_audio_output_terminal_desc_t.">APP_USBD_AUDIO_OUTPUT_TERMINAL_DSC</a>(</div>
<div class="line">                                    3,                                      <span class="comment">/* Terminal ID */</span></div>
<div class="line">                                    <a class="code" href="group__app__usbd__audio__types.html#ggae0b8009c9bf0ca55d9e7588fdbcef2a2a8c44f0163a94018d09bd246905a8d29f">APP_USBD_AUDIO_TERMINAL_OUT_HEADPHONES</a>, <span class="comment">/* Terminal type */</span></div>
<div class="line">                                    2)                                      <span class="comment">/* Source ID */</span></div>
<div class="line">                                );</div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment">   @brief   Audio class feature unit descriptor</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><a class="code" href="group__app__usbd__audio.html#gacac7141bf9871e2174cd314f5ac04bcd" title="Initializer of Feture Output descriptor.">APP_USBD_AUDIO_FEATURE_DESCRIPTOR</a>(m_hp_fea_desc, </div>
<div class="line">                                  <a class="code" href="group__app__usbd__audio__dsc.html#ga56894650782f3c8f69cc63528cc1e196" title="Initializer of app_usbd_audio_feature_unit_desc_t.">APP_USBD_AUDIO_FEATURE_UNIT_DSC</a>(</div>
<div class="line">                                    2,                     <span class="comment">/* Unit ID */</span></div>
<div class="line">                                    1,                     <span class="comment">/* Source ID */</span></div>
<div class="line">                                    HP_FEATURE_CONTROLS()) <span class="comment">/* List of controls */</span></div>
<div class="line">                                 );</div>
</div><!-- fragment --><h1><a class="anchor" id="define_audio_class"></a>
Defining audio classes</h1>
<p>When all descriptors are correctly defined, you can define the audio class: </p>
<div class="fragment"><div class="line"><span class="preprocessor">#define HP_INTERFACES_CONFIG() APP_USBD_AUDIO_CONFIG_OUT(0, 1)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><a class="code" href="group__app__usbd__audio.html#ga2218189d07de31e574302733242503b8" title="Global definition of app_usbd_audio_t class instance.">APP_USBD_AUDIO_GLOBAL_DEF</a>(m_app_audio_headphone,</div>
<div class="line">                          HP_INTERFACES_CONFIG(),</div>
<div class="line">                          hp_audio_user_ev_handler,</div>
<div class="line">                          &amp;m_hp_form_desc,</div>
<div class="line">                          &amp;m_hp_inp_desc,</div>
<div class="line">                          &amp;m_hp_out_desc,</div>
<div class="line">                          &amp;m_hp_fea_desc,</div>
<div class="line">                          0,</div>
<div class="line">                          <a class="code" href="group__app__usbd__audio__types.html#gga3edebfb6ad8b81440c0e4048f79fb16ba172bf2e3ab55a8f991162175b9a7c9b0">APP_USBD_AUDIO_AS_IFACE_FORMAT_PCM</a>,</div>
<div class="line">                          192,</div>
<div class="line">                          <a class="code" href="group__app__usbd__audio__types.html#gga7f3068a1274815ca0063d91bcb3e6d1bad098ddcaed64b473afc49b9950e51bfb">APP_USBD_AUDIO_SUBCLASS_AUDIOSTREAMING</a>,</div>
<div class="line">                          1</div>
<div class="line">);</div>
</div><!-- fragment --><p>If you wish to skip an optional descriptor, use NULL: </p>
<div class="fragment"><div class="line"><a class="code" href="group__app__usbd__audio.html#ga2218189d07de31e574302733242503b8" title="Global definition of app_usbd_audio_t class instance.">APP_USBD_AUDIO_GLOBAL_DEF</a>(m_app_audio_headphone,</div>
<div class="line">                          HP_INTERFACES_CONFIG(),</div>
<div class="line">                          hp_audio_user_ev_handler,</div>
<div class="line">                          &amp;m_hp_form_desc,</div>
<div class="line">                          &amp;m_hp_inp_desc,</div>
<div class="line">                          NULL,</div>
<div class="line">                          &amp;m_hp_fea_desc,</div>
<div class="line">                          0,</div>
<div class="line">                          <a class="code" href="group__app__usbd__audio__types.html#gga3edebfb6ad8b81440c0e4048f79fb16ba172bf2e3ab55a8f991162175b9a7c9b0">APP_USBD_AUDIO_AS_IFACE_FORMAT_PCM</a>,</div>
<div class="line">                          192,</div>
<div class="line">                          <a class="code" href="group__app__usbd__audio__types.html#gga7f3068a1274815ca0063d91bcb3e6d1bad098ddcaed64b473afc49b9950e51bfb">APP_USBD_AUDIO_SUBCLASS_AUDIOSTREAMING</a>,</div>
<div class="line">                          1</div>
<div class="line">);</div>
</div><!-- fragment --><h1><a class="anchor" id="sof_in_audio_class"></a>
Using SOF events to start transfers in the audio class</h1>
<p>To work with isochronous endpoints, you must use a SOF event. This means that the SOF event must be activated when calling the <a class="el" href="group__app__usbd.html#ga5b0ac80bcb0f2440027bf9173981c69f">app_usbd_init</a> function:</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> usbd_user_ev_handler(<a class="code" href="group__app__usbd__types.html#gae307a374b0c1a5fa6b9dc07fa517e331" title="Events codes.">app_usbd_event_type_t</a> event)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// ... State processing</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="group__sdk__error.html#gaf6c20fb483036617204f12e99e0b997b" title="API Result.">ret_code_t</a> ret;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="structapp__usbd__config__t.html" title="Configuration passed to app_usbd_init.">app_usbd_config_t</a> usbd_config = {</div>
<div class="line">        .<a class="code" href="structapp__usbd__config__t.html#a80e48eb2351b9b163b1c42a64dd4e226" title="User defined event processor.">ev_state_proc</a> = usbd_user_ev_handler,</div>
<div class="line">        .enable_sof = <span class="keyword">true</span></div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ... Some hardware initiation</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    ret = <a class="code" href="group__app__usbd.html#ga5b0ac80bcb0f2440027bf9173981c69f" title="USB library initialization.">app_usbd_init</a>(&amp;usbd_config);</div>
<div class="line">    <a class="code" href="group__app__error.html#ga82d00a810dcea7dcc6af469461fb254c" title="Macro for calling error handler function if supplied error code any other than NRF_SUCCESS.">APP_ERROR_CHECK</a>(ret);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ... Rest of the code</span></div>
<div class="line">}</div>
</div><!-- fragment --><p>When timing is critical, it is possible to prepare for processing the SOF event directly in the interrupt - before the event queue is processed:</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> usbd_user_ev_handler(<a class="code" href="group__app__usbd__types.html#gae307a374b0c1a5fa6b9dc07fa517e331" title="Events codes.">app_usbd_event_type_t</a> event)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// ... State processing</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> usbd_user_isr_handler(<a class="code" href="unionapp__usbd__internal__evt__t.html" title="Internal event variable type.">app_usbd_internal_evt_t</a> <span class="keyword">const</span> * <span class="keyword">const</span> p_event, <span class="keywordtype">bool</span> queued);</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// ... Events processed directly in interrupt</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="group__sdk__error.html#gaf6c20fb483036617204f12e99e0b997b" title="API Result.">ret_code_t</a> ret;</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="structapp__usbd__config__t.html" title="Configuration passed to app_usbd_init.">app_usbd_config_t</a> usbd_config = {</div>
<div class="line">        .<a class="code" href="structapp__usbd__config__t.html#a1abdee6472ea738835e1246176e943c2" title="User defined event handler.">ev_isr_handler</a> = usbd_user_isr_handler,</div>
<div class="line">        .ev_state_proc = usbd_user_ev_handler,</div>
<div class="line">        .enable_sof = <span class="keyword">true</span></div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ... Some hardware initiation</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    ret = <a class="code" href="group__app__usbd.html#ga5b0ac80bcb0f2440027bf9173981c69f" title="USB library initialization.">app_usbd_init</a>(&amp;usbd_config);</div>
<div class="line">    <a class="code" href="group__app__error.html#ga82d00a810dcea7dcc6af469461fb254c" title="Macro for calling error handler function if supplied error code any other than NRF_SUCCESS.">APP_ERROR_CHECK</a>(ret);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ... Rest of the code</span></div>
<div class="line">}</div>
</div><!-- fragment --><p>When the SOF event is processed, transfer may be started in any direction inside this event. The following example code shows transferring of audio data from the headphones to the buffer:</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> usbd_user_ev_handler(<a class="code" href="group__app__usbd__types.html#gae307a374b0c1a5fa6b9dc07fa517e331" title="Events codes.">app_usbd_event_type_t</a> event)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">switch</span>(event)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__app__usbd__types.html#ggae307a374b0c1a5fa6b9dc07fa517e331a0cd83b5b4bca5e560d39820ba3daf7c5">APP_USBD_EVT_DRV_SOF</a>:</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="group__app__usbd__core.html#gga8ef72aaf623253bf78f47eb9707103c0ad6dd56382907dc1bb3a067bf47022abf">APP_USBD_STATE_Configured</a> != <a class="code" href="group__app__usbd__core.html#ga14724c533a0374e73338f7618a116cf4" title="Return internal USBD core state.">app_usbd_core_state_get</a>())</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordtype">size_t</span> rx_size = <a class="code" href="group__app__usbd__audio.html#ga3dbe4c8572e4723705e4fb735acdafbb" title="Get the size of last received transfer.">app_usbd_audio_class_rx_size_get</a>(&amp;m_app_audio_headphone.base);</div>
<div class="line">            m_temp_buffer_size = rx_size;</div>
<div class="line">            <span class="keywordflow">if</span> (rx_size &gt; 0)</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="group__sdk__error.html#gaf6c20fb483036617204f12e99e0b997b" title="API Result.">ret_code_t</a> ret;</div>
<div class="line">                ret = <a class="code" href="group__app__usbd__audio.html#ga353b37b2827ccd9fe9cce1da2bdfef87" title="Start audio data copying from the endpoint buffer.">app_usbd_audio_class_rx_start</a>(&amp;m_app_audio_headphone.base, m_temp_buffer, rx_size);</div>
<div class="line">                <span class="keywordflow">if</span> (<a class="codeRef" doxygen="tag_s140_offline.tag:../s140/" href="../s140/group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123">NRF_SUCCESS</a> != ret)</div>
<div class="line">                {</div>
<div class="line">                    <span class="comment">// Error handling</span></div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="comment">// ... Rest of events</span></div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="event_handling_audio_class"></a>
Event handling in the audio class</h1>
<p>Audio class defines 3 events:</p>
<ul>
<li><a class="el" href="group__app__usbd__audio.html#ggaae39410102fdd20b011690d827e48250a070a9c9415d51778ffff4b9f322fc873">APP_USBD_AUDIO_USER_EVT_CLASS_REQ</a> - Audio class request - for configuration.</li>
<li><a class="el" href="group__app__usbd__audio.html#ggaae39410102fdd20b011690d827e48250ae422ac2b2b368a07dafa2eefe57633cd">APP_USBD_AUDIO_USER_EVT_RX_DONE</a> - Rx DMA transfer finished.</li>
<li><a class="el" href="group__app__usbd__audio.html#ggaae39410102fdd20b011690d827e48250a9fb5cfd200085bccdec973e6a8528dd9">APP_USBD_AUDIO_USER_EVT_TX_DONE</a> - Tx DMA transfer finished.</li>
</ul>
<p>You can pass an event handler function to the class instance definition. The following is an example of a correct audio class user event handler prototype:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> audio_user_ev_handler(<a class="code" href="structapp__usbd__class__inst__t.html">app_usbd_class_inst_t</a> <span class="keyword">const</span> * p_inst,</div>
<div class="line">                           <a class="code" href="group__app__usbd__audio.html#gaf4f4d332db9ddb57e064709ca553fd39" title="Events passed to user event handler.">app_usbd_audio_user_event_t</a>   event);</div>
</div><!-- fragment --><p>In this example code, the <a class="el" href="group__app__usbd__audio.html#ggaae39410102fdd20b011690d827e48250ae422ac2b2b368a07dafa2eefe57633cd">APP_USBD_AUDIO_USER_EVT_RX_DONE</a> event is used to start the transfer of the data received from headphone output to the microphone input:</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> hp_audio_user_ev_handler(<a class="code" href="structapp__usbd__class__inst__t.html">app_usbd_class_inst_t</a> <span class="keyword">const</span> * p_inst,</div>
<div class="line">                                     <a class="code" href="group__app__usbd__audio.html#gaf4f4d332db9ddb57e064709ca553fd39" title="Events passed to user event handler.">app_usbd_audio_user_event_t</a>   event)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="structapp__usbd__audio__t.html" title="Audio class instance type.">app_usbd_audio_t</a> <span class="keyword">const</span> * p_audio = <a class="code" href="group__app__usbd__audio.html#gacfbfafd66d4425b2e7e3607ea3dfc916" title="Helper function to get audio from base class instance.">app_usbd_audio_class_get</a>(p_inst);</div>
<div class="line">    <span class="keywordflow">switch</span> (event)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// ... Other events</span></div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__app__usbd__audio.html#ggaae39410102fdd20b011690d827e48250ae422ac2b2b368a07dafa2eefe57633cd">APP_USBD_AUDIO_USER_EVT_RX_DONE</a>:</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="group__sdk__error.html#gaf6c20fb483036617204f12e99e0b997b" title="API Result.">ret_code_t</a> ret;</div>
<div class="line">            <span class="comment">/* Block from headphones copied into buffer, send it into microphone input */</span></div>
<div class="line">            ret = <a class="code" href="group__app__usbd__audio.html#ga8762ef5b5bd79785593696ee1729e19d" title="Start copying audio data to the endpoint buffer.">app_usbd_audio_class_tx_start</a>(&amp;m_app_audio_microphone.base, m_temp_buffer, m_temp_buffer_size);</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="codeRef" doxygen="tag_s140_offline.tag:../s140/" href="../s140/group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123">NRF_SUCCESS</a> == ret)</div>
<div class="line">            {</div>
<div class="line">                bsp_board_led_invert(LED_AUDIO_RX);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="register_audio_class"></a>
Registering an audio class to the USBD library</h1>
<p>After the whole class instance is defined, you must register the new class to the USBD library:</p>
<div class="fragment"><div class="line">ret = <a class="code" href="group__app__usbd.html#ga5b0ac80bcb0f2440027bf9173981c69f" title="USB library initialization.">app_usbd_init</a>();</div>
<div class="line">ASSERT(ret == <a class="codeRef" doxygen="tag_s140_offline.tag:../s140/" href="../s140/group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123">NRF_SUCCESS</a>);</div>
<div class="line"></div>
<div class="line"><a class="code" href="structapp__usbd__class__inst__t.html">app_usbd_class_inst_t</a> <span class="keyword">const</span> * class_inst_hp = <a class="code" href="group__app__usbd__audio.html#ga48192ddd5d28d75fa33f4daa05f897dc">app_usbd_audio_class_inst_get</a>(&amp;m_app_audio_headphone);</div>
<div class="line">ret = app_usbd_controller_class_append(class_inst_hp);</div>
<div class="line">ASSERT(ret == <a class="codeRef" doxygen="tag_s140_offline.tag:../s140/" href="../s140/group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123">NRF_SUCCESS</a>);</div>
<div class="line"></div>
<div class="line"><a class="code" href="group__app__usbd.html#gae6b56c2e6aa8074c9fa5bcf61cc608dd" title="Enable USBD.">app_usbd_enable</a>();</div>
<div class="line"><a class="code" href="group__app__usbd.html#ga13088881a90703a337690c3eb4c930ee" title="Request USBD to start.">app_usbd_start</a>();</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<div id="nav-path" class="topicfooter">
<a href="mailto:docfeedback@nordicsemi.no?subject=Documentation%20feedback" id="maillink">Documentation feedback</a> | <a href="https://devzone.nordicsemi.com/questions/" target="_blank">Developer Zone</a> | <a href="http://response.nordicsemi.com/subscribe-to-our-newsletters" target="_blank">Subscribe</a> | Updated <span id="date"/>
<script>
var date = new Date("Mon Sep 14 2020" + " UTC");
document.getElementById("date").innerHTML = date.toJSON().slice(0, 10);
var url=window.location.href.split("?")[0];
var filename=url.substring(url.lastIndexOf('/')+1);
document.getElementById("maillink").href = "mailto:docfeedback@nordicsemi.no?subject=Documentation%20feedback"+decodeURIComponent("%26")+"body=File%20name%3A%20"+encodeURIComponent(filename);
</script>
</div>
</body>
</html>
