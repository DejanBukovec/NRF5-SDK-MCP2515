<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>nRF5 SDK v17.0.2: QSPI</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="extra_stylesheet_offline.css" rel="stylesheet" type="text/css"/>
<link href="nordic.css" rel="stylesheet" type="text/css" />
<link rel="Shortcut icon" href="./favicon.ico" type="image/x-icon" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0" width="100%" class="blank">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Nordic Semiconductor" src="nordic_small.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">nRF5 SDK
   &#160;<span id="projectnumber">v17.0.2</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
<table cellspacing="0" cellpadding="0" class="blank">
<tr>
<td class="doclinkintro">Choose documentation:</td>
<td class="doclinks" id="nrf5"><a href="../nrf5/index.html">nRF5 SDK</a></td>
<td class="doclinks" id="s112"><a href="../s112/index.html">S112 SoftDevice API</a></td>
<td class="doclinks" id="s113"><a href="../s113/index.html">S113 SoftDevice API</a></td>
<td class="doclinks" id="s122"><a href="../s122/index.html">S122 SoftDevice API</a></td>
<td class="doclinks" id="s132"><a href="../s132/index.html">S132 SoftDevice API</a></td>
<td class="doclinks" id="s140"><a href="../s140/index.html">S140 SoftDevice API</a></td>
<td class="doclinks" id="s212"><a href="../s212/index.html">S212 SoftDevice API</a></td>
<td class="doclinks" id="s312"><a href="../s312/index.html">S312 SoftDevice API</a></td>
<td class="doclinks" id="s332"><a href="../s332/index.html">S332 SoftDevice API</a></td>
<td class="doclinks" id="s340"><a href="../s340/index.html">S340 SoftDevice API</a></td>
</tr>
</table>
<script>
var url=window.location.href.split("/").reverse()[1];
var validLinks= ["nrf5","s112","s113","s122","s132","s140","s212","s312","s332","s340"];
var index;
for (index = 0; index < validLinks.length; ++index) {
   if ( url.indexOf(validLinks[index]) !== -1 ) {
      document.getElementById(validLinks[index]).setAttribute('class', 'doclinks docselected');
   };
};
</script>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('hardware_driver_qspi.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">QSPI </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="whichnRF nRF52840"><span>This information applies to the <b>nRF52840 SoC</b> only.</span></div><p>The Quad Serial Peripheral Interface (QSPI) driver includes two layers: the hardware access layer (HAL) and the driver layer (DRV).</p>
<p>The hardware access layer provides basic APIs for accessing the registers of the QSPI peripheral. For details, see the API documentation for <a class="el" href="group__nrf__qspi__hal.html">QSPI HAL</a>.</p>
<p>The driver layer provides APIs on a higher level than the HAL. For details, see the API documentation for <a class="el" href="group__nrf__drv__qspi.html">QSPI driver - legacy layer</a>.</p>
<p>Key features include:</p>
<ul>
<li>Three standard operations: write, read, and erase.</li>
<li>Custom instruction sending feature.</li>
<li>Support for the extended 32-bit addressing mode.</li>
</ul>
<p>The <a class="el" href="qspi_example.html">QSPI Example</a> provides sample code that you can use to quickly get started. Note that before the transmission starts, both the peripheral and memory must be configured, unlike for other drivers, where only the peripheral must be configured.</p>
<h1><a class="anchor" id="qspi_driver_configuration"></a>
Driver configuration</h1>
<p>The configurable parameters include:</p>
<ul>
<li>Pins to be used for QSPI peripheral signals.</li>
<li>Frequency settings that define the divider of base frequency.</li>
<li>Clock delay configuration (tSHSL, tWHSL, and tSHWL).</li>
<li>QSPI mode for read and write operations.</li>
<li>Extended address mode configuration.</li>
<li>SPI mode options (Polarization and phase).</li>
</ul>
<h1><a class="anchor" id="qspi_driver_using"></a>
Using the QSPI driver with the memory device for asynchronous transfers</h1>
<p>Writing an application that uses QSPI involves two steps:</p>
<ul>
<li>QSPI peripheral configuration using the <a class="el" href="group__nrf__drv__qspi.html#ga159e385c6c00f20dc5bed70deab70c70">nrf_drv_qspi_init</a> function.</li>
<li>Memory configuration using the custom instruction functionality - <a class="el" href="group__nrf__drv__qspi.html#gab85c751abb57d919b45828480993d374">nrf_drv_qspi_cinstr_xfer</a>.</li>
</ul>
<h2><a class="anchor" id="qspi_driver_define_function"></a>
Defining a data handling function</h2>
<p>Define a helper Boolean and the data handling function for QSPI. Example:</p>
<div class="fragment"><div class="line"><span class="keyword">volatile</span> <span class="keywordtype">bool</span> m_finished = <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> data_handler(<a class="code" href="group__nrf__drv__qspi.html#ga1cd4148424aee30da26b8742690a5bce" title="Macro for forwarding the new implementation.">nrf_drv_qspi_evt_t</a> event, <span class="keywordtype">void</span> * p_context)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (event = <a class="code" href="group__nrf__drv__qspi.html#ga51b6f82c5426b7ed4928373c2174bdcd" title="Macro for forwarding the new implementation.">NRF_DRV_QSPI_EVENT_DONE</a>)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Handle incoming event from the peripheral.</span></div>
<div class="line">        m_finished = <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="qspi_driver_initialize_driver"></a>
Initializing and configuring the driver</h2>
<p>Call <a class="el" href="group__nrf__drv__qspi.html#ga159e385c6c00f20dc5bed70deab70c70">nrf_drv_qspi_init</a> to initialize and configure the driver. For possible configuration options, refer to the <a class="el" href="group__nrf__drv__qspi.html#ga9742f82a8b1162944404fe97fc80aa2a">nrf_drv_qspi_config_t</a> structure documentation. Values in fields configured by <a class="el" href="group__nrf__drv__qspi.html#gade6b5d80f9c983bc523a643310530063">NRF_DRV_QSPI_DEFAULT_CONFIG</a> can be found in the sdk_config.h file (see the <em>QSPI_</em> prefix). Remember that the default configuration of pins is fetched from the pca10056.h file which can be found in the <em>components/boards</em> directory.</p>
<p>Example:</p>
<div class="fragment"><div class="line">uint32_t err_code;</div>
<div class="line"></div>
<div class="line"><a class="code" href="structnrfx__qspi__config__t.html" title="QSPI driver instance configuration structure.">nrf_drv_qspi_config_t</a> config = <a class="code" href="group__nrf__drv__qspi.html#gade6b5d80f9c983bc523a643310530063" title="Macro for forwarding the new implementation.">NRF_DRV_QSPI_DEFAULT_CONFIG</a>;</div>
<div class="line"></div>
<div class="line">err_code = <a class="code" href="group__nrf__drv__qspi.html#ga159e385c6c00f20dc5bed70deab70c70" title="Macro for forwarding the new implementation.">nrf_drv_qspi_init</a>(&amp;config, data_handler, NULL);</div>
<div class="line"><span class="keywordflow">if</span> (err_code != <a class="codeRef" doxygen="tag_s140_offline.tag:../s140/" href="../s140/group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123">NRF_SUCCESS</a>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Initialization failed. Take recovery action.</span></div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="qspi_driver_config_memory"></a>
Configuring memory</h2>
<p>Configure the memory using proper custom instructions. This task depends on the chosen memory. Refer to the memory documentation before writing code. The example code below works with MX25L6435F memory which can be find on the PCA10056 Development Kit.</p>
<p>Remember that <a class="el" href="group__nrf__drv__qspi.html#gab85c751abb57d919b45828480993d374">nrf_drv_qspi_cinstr_xfer</a> is a synchronous function and it does not require checking the status flags in peripheral registers.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define QSPI_MEM_CMD_RST_EN  0x66</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define QSPI_MEM_CMD_RST_MEM 0x99</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define QSPI_MEM_CMD_WRSR    0x01</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define QSPI_MEM_QUAD_MODE   0x40</span></div>
<div class="line"><span class="preprocessor"></span>...</div>
<div class="line"></div>
<div class="line">uint8_t transfer_byte = 0x40;</div>
<div class="line"><a class="code" href="structnrf__qspi__cinstr__conf__t.html" title="Custom instruction configuration.">nrf_qspi_cinstr_conf_t</a> cinstr_cfg = {</div>
<div class="line">    .<a class="code" href="structnrf__qspi__cinstr__conf__t.html#a2c9212298aaae1aaa36f2fff60e173fd">opcode</a>    = QSPI_MEM_CMD_RST_EN,</div>
<div class="line">    .length    = <a class="code" href="group__nrf__qspi__hal.html#gga290902bf6e6edc2202de3fc9a91fb180a5bf21927cf310039c4277d1e73f6be18">NRF_QSPI_CINSTR_LEN_1B</a>,</div>
<div class="line">    .io2_level = <span class="keyword">true</span>,</div>
<div class="line">    .io3_level = <span class="keyword">true</span>,</div>
<div class="line">    .wipwait   = <span class="keyword">true</span>,</div>
<div class="line">    .wren      = <span class="keyword">true</span></div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// Enable memory reset function.</span></div>
<div class="line"><a class="code" href="group__nrf__drv__qspi.html#gab85c751abb57d919b45828480993d374" title="Macro for forwarding the new implementation.">nrf_drv_qspi_cinstr_xfer</a>(&amp;cinstr_cfg, &amp;transfer_byte, NULL, <span class="keyword">false</span>);</div>
<div class="line"></div>
<div class="line"><span class="comment">// Reset the memory.</span></div>
<div class="line">cinstr_cfg.<a class="code" href="structnrf__qspi__cinstr__conf__t.html#a2c9212298aaae1aaa36f2fff60e173fd">opcode</a> = QSPI_MEM_CMD_RST_MEM;</div>
<div class="line"><a class="code" href="group__nrf__drv__qspi.html#gab85c751abb57d919b45828480993d374" title="Macro for forwarding the new implementation.">nrf_drv_qspi_cinstr_xfer</a>(&amp;cinstr_cfg, &amp;transfer_byte, NULL, <span class="keyword">false</span>);</div>
<div class="line"></div>
<div class="line"><span class="comment">// Enable quad mode.</span></div>
<div class="line">cinstr_cfg.<a class="code" href="structnrf__qspi__cinstr__conf__t.html#a2c9212298aaae1aaa36f2fff60e173fd">opcode</a>    = QSPI_STD_CMD_WRSR;</div>
<div class="line">cinstr_cfg.<a class="code" href="structnrf__qspi__cinstr__conf__t.html#a86d195ef09cf482514ddcdfbc4a4ef55">length</a>    = <a class="code" href="group__nrf__qspi__hal.html#gga290902bf6e6edc2202de3fc9a91fb180a53fe71dcd5a830ef892f31a8ccf60be7">NRF_QSPI_CINSTR_LEN_2B</a>;</div>
<div class="line"><a class="code" href="group__nrf__drv__qspi.html#gab85c751abb57d919b45828480993d374" title="Macro for forwarding the new implementation.">nrf_drv_qspi_cinstr_xfer</a>(&amp;cinstr_cfg, &amp;transfer_byte, NULL, <span class="keyword">false</span>);</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>Before peripheral initialization, if the memory used in the system supports the 32-bit addressing mode, set the addrmode field in the <a class="el" href="group__nrf__drv__qspi.html#ga9742f82a8b1162944404fe97fc80aa2a">nrf_drv_qspi_config_t</a> instance. Then, after peripheral initialization, send a proper custom instruction to the memory device.</dd></dl>
<h2><a class="anchor" id="qspi_driver_transfer_data"></a>
Transferring data</h2>
<p>You can now use <a class="el" href="group__nrf__drv__qspi.html#gac3b75dca17dff7c55552102bcf480338">nrf_drv_qspi_write</a> and <a class="el" href="group__nrf__drv__qspi.html#ga3b1439b5c036ced133fd6ae351201fee">nrf_drv_qspi_read</a> to transfer data. Memory status is checked automatically before the start of read, write, and erase operations. The event comes after the last operation is finished.</p>
<div class="image">
<img src="QSPI_write_example.svg" alt="QSPI_write_example.svg"/>
<div class="caption">
Example of a write operation. Checking status byte and event generation.</div></div>
<p> Remember to align the adress to four bytes. You do not need to check how much data will be transfered into memory during one transfer. The peripheral splits data into 256-byte transfers. </p>
<dl class="section note"><dt>Note</dt><dd>In many cases, memories have a 256-byte page buffer and it is important to wait for the transfer to finish before filling the buffer with new data to avoid data corruption.</dd></dl>
<div class="fragment"><div class="line">uint8_t m_buffer_tx[QSPI_TEST_DATA_SIZE];</div>
<div class="line">uint8_t m_buffer_rx[QSPI_TEST_DATA_SIZE];</div>
<div class="line"><a class="code" href="group__nrf__drv__qspi.html#gac3b75dca17dff7c55552102bcf480338" title="Macro for forwarding the new implementation.">nrf_drv_qspi_write</a>(&amp;m_buffer_tx, QSPI_TEST_DATA_SIZE, 0);</div>
<div class="line"><span class="comment">// Wait until sending of opcode and data is finished.</span></div>
<div class="line"><span class="keywordflow">while</span>(!m_finished);</div>
<div class="line">m_finished = <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line"><a class="code" href="group__nrf__drv__qspi.html#ga3b1439b5c036ced133fd6ae351201fee" title="Macro for forwarding the new implementation.">nrf_drv_qspi_read</a>(&amp;m_buffer_rx, QSPI_TEST_DATA_SIZE, 0);</div>
<div class="line"><span class="comment">// Wait until reading of data from the memory device is finished.</span></div>
<div class="line"><span class="keywordflow">while</span>(!m_finished);</div>
<div class="line">m_finished = <span class="keyword">false</span>;</div>
</div><!-- fragment --><h2><a class="anchor" id="qspi_driver_erase_data"></a>
Erasing data</h2>
<ol type="1">
<li>If an erase step is required, <a class="el" href="group__nrf__drv__qspi.html#ga6c9e895ec016a221a89c237195613dcc">nrf_drv_qspi_erase</a> can be used to erase one block or <a class="el" href="group__nrf__drv__qspi.html#gaecdce7708b38b31859334bd2c65f4246">nrf_drv_qspi_chip_erase</a> to erase the whole chip. Remember that the erase operation takes a lot of time. If an erase operation is executed before a read or write operation, a long delay is observed.</li>
</ol>
<div class="fragment"><div class="line"><a class="code" href="group__nrf__drv__qspi.html#gaecdce7708b38b31859334bd2c65f4246" title="Macro for forwarding the new implementation.">nrf_drv_qspi_chip_erase</a>();</div>
<div class="line"><span class="comment">// Wait until sending of opcode is finished.</span></div>
<div class="line"><span class="keywordflow">while</span>(!m_finished);</div>
<div class="line">m_finished = <span class="keyword">false</span>;</div>
</div><!-- fragment --><p>Another option is to prepare a function that waits for Erase Finished state. Additionally, a timeout feature can be implemented in such case:</p>
<div class="fragment"><div class="line">uint32_t ms_time = 0;</div>
<div class="line"><span class="keywordflow">while</span> (<a class="code" href="group__nrf__drv__qspi.html#gafaf8b4a7377347143fd6968c286ac535" title="Macro for forwarding the new implementation.">nrf_drv_qspi_mem_busy_check</a>() == <a class="codeRef" doxygen="tag_s140_offline.tag:../s140/" href="../s140/group__nrf__error.html#ga5d2d8608f6d6a0329f58961a969e946e">NRF_ERROR_BUSY</a>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (ms_time++ &gt; timeout_ms) {</div>
<div class="line">        <span class="keywordflow">return</span> <a class="codeRef" doxygen="tag_s140_offline.tag:../s140/" href="../s140/group__nrf__error.html#gaf3ac440fa84dedc1a80baab36da36f80">NRF_ERROR_TIMEOUT</a>;</div>
<div class="line">    }</div>
<div class="line">    nrf_delay_ms(1);</div>
<div class="line">};</div>
</div><!-- fragment --><p>When the QSPI driver is no longer needed or its configuration must be changed, call <a class="el" href="group__nrf__drv__qspi.html#gac7408814b5c7e12a67fd7cb7516707f7">nrf_drv_qspi_uninit</a>. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<div id="nav-path" class="topicfooter">
<a href="mailto:docfeedback@nordicsemi.no?subject=Documentation%20feedback" id="maillink">Documentation feedback</a> | <a href="https://devzone.nordicsemi.com/questions/" target="_blank">Developer Zone</a> | <a href="http://response.nordicsemi.com/subscribe-to-our-newsletters" target="_blank">Subscribe</a> | Updated <span id="date"/>
<script>
var date = new Date("Mon Sep 14 2020" + " UTC");
document.getElementById("date").innerHTML = date.toJSON().slice(0, 10);
var url=window.location.href.split("?")[0];
var filename=url.substring(url.lastIndexOf('/')+1);
document.getElementById("maillink").href = "mailto:docfeedback@nordicsemi.no?subject=Documentation%20feedback"+decodeURIComponent("%26")+"body=File%20name%3A%20"+encodeURIComponent(filename);
</script>
</div>
</body>
</html>
