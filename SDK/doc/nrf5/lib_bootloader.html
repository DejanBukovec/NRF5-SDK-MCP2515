<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>nRF5 SDK v17.0.2: Bootloader</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="extra_stylesheet_offline.css" rel="stylesheet" type="text/css"/>
<link href="nordic.css" rel="stylesheet" type="text/css" />
<link rel="Shortcut icon" href="./favicon.ico" type="image/x-icon" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0" width="100%" class="blank">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Nordic Semiconductor" src="nordic_small.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">nRF5 SDK
   &#160;<span id="projectnumber">v17.0.2</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
<table cellspacing="0" cellpadding="0" class="blank">
<tr>
<td class="doclinkintro">Choose documentation:</td>
<td class="doclinks" id="nrf5"><a href="../nrf5/index.html">nRF5 SDK</a></td>
<td class="doclinks" id="s112"><a href="../s112/index.html">S112 SoftDevice API</a></td>
<td class="doclinks" id="s113"><a href="../s113/index.html">S113 SoftDevice API</a></td>
<td class="doclinks" id="s122"><a href="../s122/index.html">S122 SoftDevice API</a></td>
<td class="doclinks" id="s132"><a href="../s132/index.html">S132 SoftDevice API</a></td>
<td class="doclinks" id="s140"><a href="../s140/index.html">S140 SoftDevice API</a></td>
<td class="doclinks" id="s212"><a href="../s212/index.html">S212 SoftDevice API</a></td>
<td class="doclinks" id="s312"><a href="../s312/index.html">S312 SoftDevice API</a></td>
<td class="doclinks" id="s332"><a href="../s332/index.html">S332 SoftDevice API</a></td>
<td class="doclinks" id="s340"><a href="../s340/index.html">S340 SoftDevice API</a></td>
</tr>
</table>
<script>
var url=window.location.href.split("/").reverse()[1];
var validLinks= ["nrf5","s112","s113","s122","s132","s140","s212","s312","s332","s340"];
var index;
for (index = 0; index < validLinks.length; ++index) {
   if ( url.indexOf(validLinks[index]) !== -1 ) {
      document.getElementById(validLinks[index]).setAttribute('class', 'doclinks docselected');
   };
};
</script>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('lib_bootloader.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Bootloader </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The bootloader module is responsible for:</p>
<ul>
<li>booting into an application,</li>
<li>activating new firmware,</li>
<li>optionally, entering DFU mode where DFU transports are activated and new firmware can be delivered,</li>
<li>feeding the watchdog timer.</li>
</ul>
<p>Each bootloader example provided in this SDK contains one DFU transport.</p>
<p>For an overview of its API, see <a class="el" href="group__nrf__bootloader.html">Bootloader modules</a>.</p>
<h1><a class="anchor" id="lib_bootloader_settings_page"></a>
Bootloader Settings page</h1>
<p>A page in non-volatile memory (see <a class="el" href="lib_bootloader.html#lib_bootloader_memory">Memory layout</a>) is used to keep the bootloader and DFU information. The settings page contains information about:</p>
<ul>
<li>current firmware - size, CRC-32,</li>
<li>pending firmware - size, CRC-32,</li>
<li>progress of the firmware update,</li>
<li>progress of the firmware activation,</li>
<li>current firmware versions (application and bootloader),</li>
<li>transport-specific data.</li>
</ul>
<h1><a class="anchor" id="lib_bootloader_firmware_activation"></a>
Firmware activation</h1>
<p>Firmware activation is the final step of the firmware update process. The activation is triggered based on the information in the settings page that is read during boot-up. Firmware activation involves copying the new firmware in place of the exitsing one (in case of application dual-bank update - see <a class="el" href="lib_bootloader_dfu_banks.html">Dual-bank and single-bank updates</a>), and updating the settings page to allow the new firmware to boot. The bootloader ensures that copying is power fail-safe. In case of updating bootloader, MBR feature is used to perform power fail-safe copy (<a class="elRef" doxygen="tag_s212_offline.tag:../s212/" href="../s212/group___n_r_f___m_b_r___e_n_u_m_s.html#ggad416fbc71855eb8e1533a812164b85a7a56ab45130d67e73165ac12b66e8db127">SD_MBR_COMMAND_COPY_BL</a>).</p>
<h1><a class="anchor" id="lib_bootloader_dfu_mode"></a>
DFU mode</h1>
<p>In the DFU mode, the bootloader activates the DFU transports and the device is ready to receive new firmware. The bootloader enters the DFU mode on the following conditions:</p>
<ul>
<li>No valid application is present.</li>
<li>SoftDevice is activated and a valid application is present. In that case, the bootloader expects that an application update can be requested by the host.</li>
<li>Entering DFU mode is triggered by one of the optional sources:<ul>
<li>Button (<a class="el" href="group__nrf__bootloader__config.html#ga2a0043889d40d5b09e524cc701f93fbf">NRF_BL_DFU_ENTER_METHOD_BUTTON</a>),</li>
<li>Pin reset (<a class="el" href="group__nrf__bootloader__config.html#gaa89bea64482f2c4d83919922e5e84bc3">NRF_BL_DFU_ENTER_METHOD_PINRESET</a>),</li>
<li>Special value in GPREGRET register (<a class="el" href="group__nrf__bootloader__config.html#ga4e1297da5d25948277b4323a6fb87659">NRF_BL_DFU_ENTER_METHOD_GPREGRET</a>),</li>
<li>Request from the application written to the settings page (<a class="el" href="group__nrf__bootloader__config.html#gab540083b75cd50e020bbd166198476c4">NRF_BL_DFU_ENTER_METHOD_BUTTONLESS</a>).</li>
</ul>
</li>
</ul>
<p>When the DFU mode is entered, the inactivity timer is started. On timer expiration, the bootloader resets. The inactivity timer is restarted on any DFU activity. The inactivity timeout is by default set to <a class="el" href="group__nrf__bootloader__config.html#gac4b458d2cbbdc42f27f223871360b546">NRF_BL_DFU_INACTIVITY_TIMEOUT_MS</a>. If the DFU mode is entered after the SoftDevice activation, then the timeout is set to <a class="el" href="group__nrf__bootloader__config.html#ga48a68abe11ab668cac523cc448a4c927">NRF_BL_DFU_CONTINUATION_TIMEOUT_MS</a>.</p>
<h1><a class="anchor" id="lib_bootloader_app_start"></a>
Starting the application</h1>
<p>Based on information from the settings page, the bootloader determines whether the application exists and where it is located. The bootloader checks the integrity of the application before starting. Optionally, the integrity check can be skipped in certain cases to reduce boot-up time (<a class="el" href="group__nrf__bootloader__config.html#gae5beef093d98f33676857579e2ce724a">NRF_BL_APP_CRC_CHECK_SKIPPED_ON_GPREGRET2</a>, <a class="el" href="group__nrf__bootloader__config.html#ga43051a9dcb0e68d8c415b09ab28e589e">NRF_BL_APP_CRC_CHECK_SKIPPED_ON_SYSTEMOFF_RESET</a>). If one of the following conditions occurs, the bootloader enters the DFU mode:</p>
<ul>
<li>no application is installed,</li>
<li>the integrity check fails,</li>
<li>there is no settings page.</li>
</ul>
<h1><a class="anchor" id="lib_bootloader_watchdog"></a>
Watchdog timer support</h1>
<p>The bootloader detects whether the watchdog timer (WDT) is active and feeds it to prevent watchdog reset.</p>
<h1><a class="anchor" id="lib_bootloader_deps"></a>
Bootloader dependencies</h1>
<p>Bootloader modules, except for the transports, do not depend on the SoftDevice. Only the BLE DFU transport (see <a class="el" href="lib_dfu_transport_ble.html">BLE</a>) depends on the SoftDevice.</p>
<p>The bootloader supports the case where SoftDevice is not present in the system at all.</p>
<h1><a class="anchor" id="lib_bootloader_programming"></a>
Programming the bootloader</h1>
<p>During the system startup, the Master Boot Record (MBR) is responsible for starting the bootloader if a bootloader is installed. To do this, the MBR must know the start address of the bootloader. This start address is defined in either the MBR itself, or in <a href="https://infocenter.nordicsemi.com/topic/com.nordic.infocenter.s132.api.v7.2.0/group___n_r_f___m_b_r___d_e_f_i_n_e_s.html#ga3a26bf76b9300a81216bb32a81b2a10d">MBR_UICR_BOOTLOADER_ADDR</a>. This must be set to the correct value when you program the bootloader. See the <a href="https://infocenter.nordicsemi.com/topic/sds_s132/SDS/s1xx/s130.html">S132 SoftDevice Specification</a> for more details. The bootloader, by default, places its start address in <a href="https://infocenter.nordicsemi.com/topic/com.nordic.infocenter.s132.api.v7.2.0/group___n_r_f___m_b_r___d_e_f_i_n_e_s.html#ga3a26bf76b9300a81216bb32a81b2a10d">MBR_UICR_BOOTLOADER_ADDR</a>, and during the first boot it writes its start address to <a href="https://infocenter.nordicsemi.com/topic/com.nordic.infocenter.s132.api.v7.2.0/group___n_r_f___m_b_r___d_e_f_i_n_e_s.html#ga21a55e684b30e9dabbf86859cd788b1a">MBR_BOOTLOADER_ADDR</a>.</p>
<p>Programming the bootloader requires the following steps:</p>
<ol type="1">
<li>Erase the device.</li>
<li>Program the SoftDevice. See <a class="el" href="getting_started_softdevice.html#getting_started_sd">Programming SoftDevices</a> for instructions.</li>
<li>Compile the bootloader.</li>
<li>Program the bootloader. See the following sections for instructions for <a class="el" href="lib_bootloader.html#lib_bootloader_programming_ses">Segger Embedded Studio</a>, <a class="el" href="lib_bootloader.html#lib_bootloader_programming_keil">Keil</a>, <a class="el" href="lib_bootloader.html#lib_bootloader_programming_iar">IAR</a>, and <a class="el" href="lib_bootloader.html#lib_bootloader_programming_nrfjprog">nrfjprog</a> directly (if you are using GCC).</li>
</ol>
<h2><a class="anchor" id="lib_bootloader_programming_ses"></a>
Programming using Segger Embedded Studio</h2>
<p>No additional action is required since softdevice and UICR are programmed implicitly by Segger Embedded Studio when bootloader application is flashed.</p>
<h2><a class="anchor" id="lib_bootloader_programming_keil"></a>
Programming using Keil</h2>
<p>You cannot write to <a href="https://infocenter.nordicsemi.com/topic/com.nordic.infocenter.s132.api.v7.2.0/group___n_r_f___m_b_r___d_e_f_i_n_e_s.html#ga3a26bf76b9300a81216bb32a81b2a10d">MBR_UICR_BOOTLOADER_ADDR</a> when using the default J-Link target driver in Keil. Therefore, you must configure Keil to use an external tool, <a href="https://infocenter.nordicsemi.com/topic/ug_nrf5x_cltools/UG/cltools/nrf5x_nrfjprogexe.html">nrfjprog</a>. To do so, select <b>Project</b> &gt; <b>Options for Target '<em>xxx</em>'</b> and configure <code>nrfjprog.exe</code> as the tool for flash programming. <code>nrfjprog.exe</code> is installed with the nRF5 MDK and must be in the Windows system path. The following screenshot shows the required settings for <code>nrfjprog.exe:</code> </p>
<div class="image">
<img src="keil_project_flash_tool_nrf52.png" alt="keil_project_flash_tool_nrf52.png"/>
<div class="caption">
Flash tool configuration in Keil</div></div>
<p>After configuring the flash command, program the bootloader as you would do with a normal application. If several J-Link emulators are connected, select the one that contains the nRF5 IC that you want to flash.</p>
<h2><a class="anchor" id="lib_bootloader_programming_iar"></a>
Programming using IAR</h2>
<p>You cannot write to <a href="https://infocenter.nordicsemi.com/topic/com.nordic.infocenter.s132.api.v7.2.0/group___n_r_f___m_b_r___d_e_f_i_n_e_s.html#ga3a26bf76b9300a81216bb32a81b2a10d">MBR_UICR_BOOTLOADER_ADDR</a> when using the default J-Link target driver in IAR. Therefore, you must set up <a href="https://infocenter.nordicsemi.com/topic/ug_nrf5x_cltools/UG/cltools/nrf5x_nrfjprogexe.html">nrfjprog</a> as an external tool. To do so, select <b>Tools</b> &gt; <b>Configure Tools</b>. <code>nrfjprog.exe</code> is installed with the nRF5 MDK and must be in the Windows system path. The following screenshot shows the settings for <code>nrfjprog.exe:</code> </p>
<div class="image">
<img src="iar_project_flash_tool_nrf52.png" alt="iar_project_flash_tool_nrf52.png"/>
<div class="caption">
Flash tool configuration in IAR</div></div>
<p>Change "app.hex" to the file name of your HEX file and the initial directory to the directory that contains the HEX file. After configuring the flash command, program the bootloader as you would do with a normal application. If several J-Link emulators are connected, select the one that contains the nRF5 IC that you want to flash.</p>
<h2><a class="anchor" id="lib_bootloader_programming_nrfjprog"></a>
Programming using nrfjprog directly</h2>
<p>You can also program the bootloader using <a href="https://infocenter.nordicsemi.com/topic/ug_nrf5x_cltools/UG/cltools/nrf5x_nrfjprogexe.html">nrfjprog</a> directly from the command line. To do so, run the following command: </p>
<div class="fragment"><div class="line">nrfjprog --reset --program application.hex --family NRF52 --sectoranduicrerase</div>
</div><!-- fragment --><p>Change "application.hex" to the file name of your HEX file.</p>
<h1><a class="anchor" id="lib_bootloader_memory"></a>
Memory layout</h1>
<p>When adding a bootloader to your device, you must be aware of where in the device memory the different firmware components are located.</p>
<p>The following table shows the memory layout for the different chips with current SoftDevices:</p>
<table class="doxtable">
<tr>
<th>Usage </th><th>Memory range nRF52832 (S132 v7.0.x) </th><th>Memory range nRF52840 (S140 v7.0.x) </th><th>Memory range nRF52810 (S112 v7.0.x)</th><th>Memory range nRF52833 (S113 v7.0.x)</th><th>Memory range nRF52833 (S140 v7.0.x)</th></tr>
<tr>
<td>Bootloader settings </td><td>0x0007 F000 - 0x0008 0000 (4 kB) </td><td>0x000F F000 - 0x0010 0000 (4 kB) </td><td>0x0002 F000 - 0x0003 0000 (4 kB) </td><td>0x0007 F000 - 0x0008 0000 (4 kB) </td><td>0x0007 F000 - 0x0008 0000 (4 kB) </td></tr>
<tr>
<td>MBR parameter storage </td><td>0x0007 E000 - 0x0007 F000 (4 kB) </td><td>0x000F E000 - 0x000F F000 (4 kB) </td><td>0x0002 E000 - 0x0002 F000 (4 kB) </td><td>0x0007 E000 - 0x0007 F000 (4 kB) </td><td>0x0007 E000 - 0x0007 F000 (4 kB) </td></tr>
<tr>
<td>Bootloader </td><td>0x0007 8000 - 0x0007 E000 (24 kB) </td><td>0x000F 8000 - 0x000F E000 (24 kB) </td><td>0x0002 8000 - 0x0002 E000 (24 kB) </td><td>0x0007 8000 - 0x0007 E000 (24 kB) </td><td>0x0007 8000 - 0x0007 E000 (24 kB) </td></tr>
<tr>
<td>Application area (incl. free space) </td><td>0x0002 6000 - 0x0007 8000 (328 kB) </td><td>0x0002 7000 - 0x000F 8000 (836 kB) </td><td>0x0001 9000 - 0x0002 8000 (60 kB) </td><td>0x0001 C000 - 0x0007 8000 (368 kB) </td><td>0x0002 6000 - 0x0007 8000 (328 kB) </td></tr>
<tr>
<td>SoftDevice </td><td>0x0000 1000 - 0x0002 6000 (148 kB) </td><td>0x0000 1000 - 0x0002 7000 (152 kB) </td><td>0x0000 1000 - 0x0001 9000 (96 kB) </td><td>0x0000 1000 - 0x0001 C000 (112 kB) </td><td>0x0000 1000 - 0x0002 6000 (148 kB) </td></tr>
<tr>
<td>Master Boot Record (MBR) </td><td>0x0000 0000 - 0x0000 1000 (4 kB) </td><td>0x0000 0000 - 0x0000 1000 (4 kB) </td><td>0x0000 0000 - 0x0000 1000 (4 kB) </td><td>0x0000 0000 - 0x0000 1000 (4 kB) </td><td>0x0000 0000 - 0x0000 1000 (4 kB) </td></tr>
</table>
<p>The following figure shows the default memory layout for nRF52 devices, where nRF52832 has a flash size of 512 kB, nRF52840 has a flash size of 1024 kB, nRF52810 has a flash size of 192 kB, and nRF52833 has a flash size of 512 kB:</p>
<div class="image">
<img src="bootloader_memory_nrf52.svg" alt="bootloader_memory_nrf52.svg"/>
</div>
<dl class="section note"><dt>Note</dt><dd>The size of the bootloader is fixed for the lifetime of the device. This is because the location (<a href="https://infocenter.nordicsemi.com/topic/com.nordic.infocenter.s132.api.v7.2.0/group___n_r_f___m_b_r___d_e_f_i_n_e_s.html#ga21a55e684b30e9dabbf86859cd788b1a">MBR_BOOTLOADER_ADDR</a>) that stores the start address of the bootloader is not (safely) updateable. See the SoftDevice Specification for more information.</dd></dl>
<p><a class="el" href="lib_secure_boot.html">Secure boot and firmware updates</a> </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<div id="nav-path" class="topicfooter">
<a href="mailto:docfeedback@nordicsemi.no?subject=Documentation%20feedback" id="maillink">Documentation feedback</a> | <a href="https://devzone.nordicsemi.com/questions/" target="_blank">Developer Zone</a> | <a href="http://response.nordicsemi.com/subscribe-to-our-newsletters" target="_blank">Subscribe</a> | Updated <span id="date"/>
<script>
var date = new Date("Mon Sep 14 2020" + " UTC");
document.getElementById("date").innerHTML = date.toJSON().slice(0, 10);
var url=window.location.href.split("?")[0];
var filename=url.substring(url.lastIndexOf('/')+1);
document.getElementById("maillink").href = "mailto:docfeedback@nordicsemi.no?subject=Documentation%20feedback"+decodeURIComponent("%26")+"body=File%20name%3A%20"+encodeURIComponent(filename);
</script>
</div>
</body>
</html>
